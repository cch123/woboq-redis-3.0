<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"><title>latency.c source code [redis/src/latency.c] - Woboq Code Browser</title>
<link rel="stylesheet" href="../../../data/qtcreator.css" title="QtCreator"/>
<link rel="alternate stylesheet" href="../../../data/kdevelop.css" title="KDevelop"/>
<script type="text/javascript" src="../../../data/jquery/jquery.min.js"></script>
<script type="text/javascript" src="../../../data/jquery/jquery-ui.min.js"></script>
<script>var file = 'redis/src/latency.c'; var root_path = '../..'; var data_path = '../../../data';</script>
<script src='../../../data/codebrowser.js'></script>
</head>
<body><div id='header'><h1 id='breadcrumb'><span>Browse the source code of </span><a href='..'>redis</a>/<a href='./'>src</a>/<a href='latency.c.html'>latency.c</a></h1></div>
<hr/><div id='content'><table class="code">
<tr><th id="1">1</th><td><i>/* The latency monitor allows to easily observe the sources of latency</i></td></tr>
<tr><th id="2">2</th><td><i> * in a Redis instance using the LATENCY command. Different latency</i></td></tr>
<tr><th id="3">3</th><td><i> * sources are monitored, like disk I/O, execution of commands, fork</i></td></tr>
<tr><th id="4">4</th><td><i> * system call, and so forth.</i></td></tr>
<tr><th id="5">5</th><td><i> *</i></td></tr>
<tr><th id="6">6</th><td><i> * ----------------------------------------------------------------------------</i></td></tr>
<tr><th id="7">7</th><td><i> *</i></td></tr>
<tr><th id="8">8</th><td><i> * Copyright (c) 2014, Salvatore Sanfilippo &lt;antirez at gmail dot com&gt;</i></td></tr>
<tr><th id="9">9</th><td><i> * All rights reserved.</i></td></tr>
<tr><th id="10">10</th><td><i> *</i></td></tr>
<tr><th id="11">11</th><td><i> * Redistribution and use in source and binary forms, with or without</i></td></tr>
<tr><th id="12">12</th><td><i> * modification, are permitted provided that the following conditions are met:</i></td></tr>
<tr><th id="13">13</th><td><i> *</i></td></tr>
<tr><th id="14">14</th><td><i> *   * Redistributions of source code must retain the above copyright notice,</i></td></tr>
<tr><th id="15">15</th><td><i> *     this list of conditions and the following disclaimer.</i></td></tr>
<tr><th id="16">16</th><td><i> *   * Redistributions in binary form must reproduce the above copyright</i></td></tr>
<tr><th id="17">17</th><td><i> *     notice, this list of conditions and the following disclaimer in the</i></td></tr>
<tr><th id="18">18</th><td><i> *     documentation and/or other materials provided with the distribution.</i></td></tr>
<tr><th id="19">19</th><td><i> *   * Neither the name of Redis nor the names of its contributors may be used</i></td></tr>
<tr><th id="20">20</th><td><i> *     to endorse or promote products derived from this software without</i></td></tr>
<tr><th id="21">21</th><td><i> *     specific prior written permission.</i></td></tr>
<tr><th id="22">22</th><td><i> *</i></td></tr>
<tr><th id="23">23</th><td><i> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"</i></td></tr>
<tr><th id="24">24</th><td><i> * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</i></td></tr>
<tr><th id="25">25</th><td><i> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</i></td></tr>
<tr><th id="26">26</th><td><i> * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE</i></td></tr>
<tr><th id="27">27</th><td><i> * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR</i></td></tr>
<tr><th id="28">28</th><td><i> * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF</i></td></tr>
<tr><th id="29">29</th><td><i> * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS</i></td></tr>
<tr><th id="30">30</th><td><i> * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN</i></td></tr>
<tr><th id="31">31</th><td><i> * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)</i></td></tr>
<tr><th id="32">32</th><td><i> * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</i></td></tr>
<tr><th id="33">33</th><td><i> * POSSIBILITY OF SUCH DAMAGE.</i></td></tr>
<tr><th id="34">34</th><td><i> */</i></td></tr>
<tr><th id="35">35</th><td></td></tr>
<tr><th id="36">36</th><td><u>#include <a href="redis.h.html">"redis.h"</a></u></td></tr>
<tr><th id="37">37</th><td></td></tr>
<tr><th id="38">38</th><td><i>/* Dictionary type for latency events. */</i></td></tr>
<tr><th id="39">39</th><td><em>int</em> <dfn class="decl def fn" id="dictStringKeyCompare" title='dictStringKeyCompare' data-ref="dictStringKeyCompare">dictStringKeyCompare</dfn>(<em>void</em> *<dfn class="local col1 decl" id="1privdata" title='privdata' data-type='void *' data-ref="1privdata">privdata</dfn>, <em>const</em> <em>void</em> *<dfn class="local col2 decl" id="2key1" title='key1' data-type='const void *' data-ref="2key1">key1</dfn>, <em>const</em> <em>void</em> *<dfn class="local col3 decl" id="3key2" title='key2' data-type='const void *' data-ref="3key2">key2</dfn>) {</td></tr>
<tr><th id="40">40</th><td>    <a class="macro" href="redis.h.html#309" title="((void) privdata)" data-ref="_M/REDIS_NOTUSED">REDIS_NOTUSED</a>(<a class="local col1 ref" href="#1privdata" title='privdata' data-ref="1privdata">privdata</a>);</td></tr>
<tr><th id="41">41</th><td>    <b>return</b> <a class="ref fn" href="../../include/string.h.html#strcmp" title='strcmp' data-ref="strcmp">strcmp</a>(<a class="local col2 ref" href="#2key1" title='key1' data-ref="2key1">key1</a>,<a class="local col3 ref" href="#3key2" title='key2' data-ref="3key2">key2</a>) == <var>0</var>;</td></tr>
<tr><th id="42">42</th><td>}</td></tr>
<tr><th id="43">43</th><td></td></tr>
<tr><th id="44">44</th><td><em>unsigned</em> <em>int</em> <dfn class="decl def fn" id="dictStringHash" title='dictStringHash' data-ref="dictStringHash">dictStringHash</dfn>(<em>const</em> <em>void</em> *<dfn class="local col4 decl" id="4key" title='key' data-type='const void *' data-ref="4key">key</dfn>) {</td></tr>
<tr><th id="45">45</th><td>    <b>return</b> <a class="ref fn" href="dict.h.html#dictGenHashFunction" title='dictGenHashFunction' data-ref="dictGenHashFunction">dictGenHashFunction</a>(<a class="local col4 ref" href="#4key" title='key' data-ref="4key">key</a>, <a class="ref fn" href="../../include/string.h.html#strlen" title='strlen' data-ref="strlen">strlen</a>(<a class="local col4 ref" href="#4key" title='key' data-ref="4key">key</a>));</td></tr>
<tr><th id="46">46</th><td>}</td></tr>
<tr><th id="47">47</th><td></td></tr>
<tr><th id="48">48</th><td><em>void</em> <dfn class="decl fn" id="dictVanillaFree" title='dictVanillaFree' data-ref="dictVanillaFree">dictVanillaFree</dfn>(<em>void</em> *<dfn class="local col5 decl" id="5privdata" title='privdata' data-type='void *' data-ref="5privdata">privdata</dfn>, <em>void</em> *<dfn class="local col6 decl" id="6val" title='val' data-type='void *' data-ref="6val">val</dfn>);</td></tr>
<tr><th id="49">49</th><td></td></tr>
<tr><th id="50">50</th><td><a class="typedef" href="dict.h.html#dictType" title='dictType' data-type='struct dictType' data-ref="dictType">dictType</a> <dfn class="decl def" id="latencyTimeSeriesDictType" title='latencyTimeSeriesDictType' data-ref="latencyTimeSeriesDictType">latencyTimeSeriesDictType</dfn> = {</td></tr>
<tr><th id="51">51</th><td>    <a class="ref fn" href="#dictStringHash" title='dictStringHash' data-ref="dictStringHash">dictStringHash</a>,             <i>/* hash function */</i></td></tr>
<tr><th id="52">52</th><td>    <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>,                       <i>/* key dup */</i></td></tr>
<tr><th id="53">53</th><td>    <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>,                       <i>/* val dup */</i></td></tr>
<tr><th id="54">54</th><td>    <a class="ref fn" href="#dictStringKeyCompare" title='dictStringKeyCompare' data-ref="dictStringKeyCompare">dictStringKeyCompare</a>,       <i>/* key compare */</i></td></tr>
<tr><th id="55">55</th><td>    <a class="ref fn" href="#dictVanillaFree" title='dictVanillaFree' data-ref="dictVanillaFree">dictVanillaFree</a>,            <i>/* key destructor */</i></td></tr>
<tr><th id="56">56</th><td>    <a class="ref fn" href="#dictVanillaFree" title='dictVanillaFree' data-ref="dictVanillaFree">dictVanillaFree</a>             <i>/* val destructor */</i></td></tr>
<tr><th id="57">57</th><td>};</td></tr>
<tr><th id="58">58</th><td></td></tr>
<tr><th id="59">59</th><td><i>/* ------------------------- Utility functions ------------------------------ */</i></td></tr>
<tr><th id="60">60</th><td></td></tr>
<tr><th id="61">61</th><td><u>#<span data-ppcond="61">ifdef</span> <span class="macro" data-ref="_M/__linux__">__linux__</span></u></td></tr>
<tr><th id="62">62</th><td><i>/* Returns 1 if Transparent Huge Pages support is enabled in the kernel.</i></td></tr>
<tr><th id="63">63</th><td><i> * Otherwise (or if we are unable to check) 0 is returned. */</i></td></tr>
<tr><th id="64">64</th><td><em>int</em> <dfn class="decl def fn" id="THPIsEnabled" title='THPIsEnabled' data-ref="THPIsEnabled">THPIsEnabled</dfn>(<em>void</em>) {</td></tr>
<tr><th id="65">65</th><td>    <em>char</em> <dfn class="local col7 decl" id="7buf" title='buf' data-type='char [1024]' data-ref="7buf">buf</dfn>[<var>1024</var>];</td></tr>
<tr><th id="66">66</th><td></td></tr>
<tr><th id="67">67</th><td>    <a class="typedef" href="../../include/stdio.h.html#FILE" title='FILE' data-type='struct _IO_FILE' data-ref="FILE">FILE</a> *<dfn class="local col8 decl" id="8fp" title='fp' data-type='FILE *' data-ref="8fp">fp</dfn> = <a class="ref fn" href="../../include/stdio.h.html#283" title='fopen' data-ref="fopen64">fopen</a>(<q>"/sys/kernel/mm/transparent_hugepage/enabled"</q>,<q>"r"</q>);</td></tr>
<tr><th id="68">68</th><td>    <b>if</b> (!<a class="local col8 ref" href="#8fp" title='fp' data-ref="8fp">fp</a>) <b>return</b> <var>0</var>;</td></tr>
<tr><th id="69">69</th><td>    <b>if</b> (<a class="ref fn" href="../../include/stdio.h.html#fgets" title='fgets' data-ref="fgets">fgets</a>(<a class="local col7 ref" href="#7buf" title='buf' data-ref="7buf">buf</a>,<b>sizeof</b>(<a class="local col7 ref" href="#7buf" title='buf' data-ref="7buf">buf</a>),<a class="local col8 ref" href="#8fp" title='fp' data-ref="8fp">fp</a>) == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) {</td></tr>
<tr><th id="70">70</th><td>        <a class="ref fn" href="../../include/stdio.h.html#fclose" title='fclose' data-ref="fclose">fclose</a>(<a class="local col8 ref" href="#8fp" title='fp' data-ref="8fp">fp</a>);</td></tr>
<tr><th id="71">71</th><td>        <b>return</b> <var>0</var>;</td></tr>
<tr><th id="72">72</th><td>    }</td></tr>
<tr><th id="73">73</th><td>    <a class="ref fn" href="../../include/stdio.h.html#fclose" title='fclose' data-ref="fclose">fclose</a>(<a class="local col8 ref" href="#8fp" title='fp' data-ref="8fp">fp</a>);</td></tr>
<tr><th id="74">74</th><td>    <b>return</b> (<a class="ref fn" href="../../include/string.h.html#strstr" title='strstr' data-ref="strstr">strstr</a>(<a class="local col7 ref" href="#7buf" title='buf' data-ref="7buf">buf</a>,<q>"[never]"</q>) == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) ? <var>1</var> : <var>0</var>;</td></tr>
<tr><th id="75">75</th><td>}</td></tr>
<tr><th id="76">76</th><td><u>#<span data-ppcond="61">endif</span></u></td></tr>
<tr><th id="77">77</th><td></td></tr>
<tr><th id="78">78</th><td><i>/* Report the amount of AnonHugePages in smap, in bytes. If the return</i></td></tr>
<tr><th id="79">79</th><td><i> * value of the function is non-zero, the process is being targeted by</i></td></tr>
<tr><th id="80">80</th><td><i> * THP support, and is likely to have memory usage / latency issues. */</i></td></tr>
<tr><th id="81">81</th><td><em>int</em> <dfn class="decl def fn" id="THPGetAnonHugePagesSize" title='THPGetAnonHugePagesSize' data-ref="THPGetAnonHugePagesSize">THPGetAnonHugePagesSize</dfn>(<em>void</em>) {</td></tr>
<tr><th id="82">82</th><td>    <b>return</b> <a class="ref fn" href="zmalloc.h.html#zmalloc_get_smap_bytes_by_field" title='zmalloc_get_smap_bytes_by_field' data-ref="zmalloc_get_smap_bytes_by_field">zmalloc_get_smap_bytes_by_field</a>(<q>"AnonHugePages:"</q>);</td></tr>
<tr><th id="83">83</th><td>}</td></tr>
<tr><th id="84">84</th><td></td></tr>
<tr><th id="85">85</th><td><i>/* ---------------------------- Latency API --------------------------------- */</i></td></tr>
<tr><th id="86">86</th><td></td></tr>
<tr><th id="87">87</th><td><i>/* Latency monitor initialization. We just need to create the dictionary</i></td></tr>
<tr><th id="88">88</th><td><i> * of time series, each time serie is craeted on demand in order to avoid</i></td></tr>
<tr><th id="89">89</th><td><i> * having a fixed list to maintain. */</i></td></tr>
<tr><th id="90">90</th><td><em>void</em> <dfn class="decl def fn" id="latencyMonitorInit" title='latencyMonitorInit' data-ref="latencyMonitorInit">latencyMonitorInit</dfn>(<em>void</em>) {</td></tr>
<tr><th id="91">91</th><td>    <a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a> = <a class="ref fn" href="dict.h.html#dictCreate" title='dictCreate' data-ref="dictCreate">dictCreate</a>(&amp;<a class="ref" href="#latencyTimeSeriesDictType" title='latencyTimeSeriesDictType' data-ref="latencyTimeSeriesDictType">latencyTimeSeriesDictType</a>,<span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>);</td></tr>
<tr><th id="92">92</th><td>}</td></tr>
<tr><th id="93">93</th><td></td></tr>
<tr><th id="94">94</th><td><i>/* Add the specified sample to the specified time series "event".</i></td></tr>
<tr><th id="95">95</th><td><i> * This function is usually called via latencyAddSampleIfNeeded(), that</i></td></tr>
<tr><th id="96">96</th><td><i> * is a macro that only adds the sample if the latency is higher than</i></td></tr>
<tr><th id="97">97</th><td><i> * server.latency_monitor_threshold. */</i></td></tr>
<tr><th id="98">98</th><td><em>void</em> <dfn class="decl def fn" id="latencyAddSample" title='latencyAddSample' data-ref="latencyAddSample">latencyAddSample</dfn>(<em>char</em> *<dfn class="local col9 decl" id="9event" title='event' data-type='char *' data-ref="9event">event</dfn>, <a class="typedef" href="redis.h.html#mstime_t" title='mstime_t' data-type='long long' data-ref="mstime_t">mstime_t</a> <dfn class="local col0 decl" id="10latency" title='latency' data-type='mstime_t' data-ref="10latency">latency</dfn>) {</td></tr>
<tr><th id="99">99</th><td>    <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col1 decl" id="11ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="11ts">ts</dfn> = <a class="ref fn" href="dict.h.html#dictFetchValue" title='dictFetchValue' data-ref="dictFetchValue">dictFetchValue</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>,<a class="local col9 ref" href="#9event" title='event' data-ref="9event">event</a>);</td></tr>
<tr><th id="100">100</th><td>    <a class="typedef" href="../../include/time.h.html#time_t" title='time_t' data-type='__time_t' data-ref="time_t">time_t</a> <dfn class="local col2 decl" id="12now" title='now' data-type='time_t' data-ref="12now">now</dfn> = <a class="ref fn" href="../../include/time.h.html#time" title='time' data-ref="time">time</a>(<span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>);</td></tr>
<tr><th id="101">101</th><td>    <em>int</em> <dfn class="local col3 decl" id="13prev" title='prev' data-type='int' data-ref="13prev">prev</dfn>;</td></tr>
<tr><th id="102">102</th><td></td></tr>
<tr><th id="103">103</th><td>    <i>/* Create the time series if it does not exist. */</i></td></tr>
<tr><th id="104">104</th><td>    <b>if</b> (<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a> == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) {</td></tr>
<tr><th id="105">105</th><td>        <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a> = <a class="ref fn" href="zmalloc.h.html#zmalloc" title='zmalloc' data-ref="zmalloc">zmalloc</a>(<b>sizeof</b>(*<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>));</td></tr>
<tr><th id="106">106</th><td>        <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> = <var>0</var>;</td></tr>
<tr><th id="107">107</th><td>        <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a> = <var>0</var>;</td></tr>
<tr><th id="108">108</th><td>        <a class="ref fn" href="../../include/string.h.html#memset" title='memset' data-ref="memset">memset</a>(<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>,<var>0</var>,<b>sizeof</b>(<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>));</td></tr>
<tr><th id="109">109</th><td>        <a class="ref fn" href="dict.h.html#dictAdd" title='dictAdd' data-ref="dictAdd">dictAdd</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>,<a class="ref fn" href="zmalloc.h.html#zstrdup" title='zstrdup' data-ref="zstrdup">zstrdup</a>(<a class="local col9 ref" href="#9event" title='event' data-ref="9event">event</a>),<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>);</td></tr>
<tr><th id="110">110</th><td>    }</td></tr>
<tr><th id="111">111</th><td></td></tr>
<tr><th id="112">112</th><td>    <i>/* If the previous sample is in the same second, we update our old sample</i></td></tr>
<tr><th id="113">113</th><td><i>     * if this latency is &gt; of the old one, or just return. */</i></td></tr>
<tr><th id="114">114</th><td>    <a class="local col3 ref" href="#13prev" title='prev' data-ref="13prev">prev</a> = (<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> + <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a> - <var>1</var>) % <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>;</td></tr>
<tr><th id="115">115</th><td>    <b>if</b> (<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col3 ref" href="#13prev" title='prev' data-ref="13prev">prev</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> == <a class="local col2 ref" href="#12now" title='now' data-ref="12now">now</a>) {</td></tr>
<tr><th id="116">116</th><td>        <b>if</b> (<a class="local col0 ref" href="#10latency" title='latency' data-ref="10latency">latency</a> &gt; <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col3 ref" href="#13prev" title='prev' data-ref="13prev">prev</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>)</td></tr>
<tr><th id="117">117</th><td>            <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col3 ref" href="#13prev" title='prev' data-ref="13prev">prev</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a> = <a class="local col0 ref" href="#10latency" title='latency' data-ref="10latency">latency</a>;</td></tr>
<tr><th id="118">118</th><td>        <b>return</b>;</td></tr>
<tr><th id="119">119</th><td>    }</td></tr>
<tr><th id="120">120</th><td></td></tr>
<tr><th id="121">121</th><td>    <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> = <a class="ref fn" href="../../include/time.h.html#time" title='time' data-ref="time">time</a>(<span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>);</td></tr>
<tr><th id="122">122</th><td>    <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a> = <a class="local col0 ref" href="#10latency" title='latency' data-ref="10latency">latency</a>;</td></tr>
<tr><th id="123">123</th><td>    <b>if</b> (<a class="local col0 ref" href="#10latency" title='latency' data-ref="10latency">latency</a> &gt; <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a>) <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a> = <a class="local col0 ref" href="#10latency" title='latency' data-ref="10latency">latency</a>;</td></tr>
<tr><th id="124">124</th><td></td></tr>
<tr><th id="125">125</th><td>    <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a>++;</td></tr>
<tr><th id="126">126</th><td>    <b>if</b> (<a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> == <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>) <a class="local col1 ref" href="#11ts" title='ts' data-ref="11ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> = <var>0</var>;</td></tr>
<tr><th id="127">127</th><td>}</td></tr>
<tr><th id="128">128</th><td></td></tr>
<tr><th id="129">129</th><td><i>/* Reset data for the specified event, or all the events data if 'event' is</i></td></tr>
<tr><th id="130">130</th><td><i> * NULL.</i></td></tr>
<tr><th id="131">131</th><td><i> *</i></td></tr>
<tr><th id="132">132</th><td><i> * Note: this is O(N) even when event_to_reset is not NULL because makes</i></td></tr>
<tr><th id="133">133</th><td><i> * the code simpler and we have a small fixed max number of events. */</i></td></tr>
<tr><th id="134">134</th><td><em>int</em> <dfn class="decl def fn" id="latencyResetEvent" title='latencyResetEvent' data-ref="latencyResetEvent">latencyResetEvent</dfn>(<em>char</em> *<dfn class="local col4 decl" id="14event_to_reset" title='event_to_reset' data-type='char *' data-ref="14event_to_reset">event_to_reset</dfn>) {</td></tr>
<tr><th id="135">135</th><td>    <a class="typedef" href="dict.h.html#dictIterator" title='dictIterator' data-type='struct dictIterator' data-ref="dictIterator">dictIterator</a> *<dfn class="local col5 decl" id="15di" title='di' data-type='dictIterator *' data-ref="15di">di</dfn>;</td></tr>
<tr><th id="136">136</th><td>    <a class="typedef" href="dict.h.html#dictEntry" title='dictEntry' data-type='struct dictEntry' data-ref="dictEntry">dictEntry</a> *<dfn class="local col6 decl" id="16de" title='de' data-type='dictEntry *' data-ref="16de">de</dfn>;</td></tr>
<tr><th id="137">137</th><td>    <em>int</em> <dfn class="local col7 decl" id="17resets" title='resets' data-type='int' data-ref="17resets">resets</dfn> = <var>0</var>;</td></tr>
<tr><th id="138">138</th><td></td></tr>
<tr><th id="139">139</th><td>    <a class="local col5 ref" href="#15di" title='di' data-ref="15di">di</a> = <a class="ref fn" href="dict.h.html#dictGetSafeIterator" title='dictGetSafeIterator' data-ref="dictGetSafeIterator">dictGetSafeIterator</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>);</td></tr>
<tr><th id="140">140</th><td>    <b>while</b>((<a class="local col6 ref" href="#16de" title='de' data-ref="16de">de</a> = <a class="ref fn" href="dict.h.html#dictNext" title='dictNext' data-ref="dictNext">dictNext</a>(<a class="local col5 ref" href="#15di" title='di' data-ref="15di">di</a>)) != <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) {</td></tr>
<tr><th id="141">141</th><td>        <em>char</em> *<dfn class="local col8 decl" id="18event" title='event' data-type='char *' data-ref="18event">event</dfn> = <a class="macro" href="dict.h.html#140" title="((de)-&gt;key)" data-ref="_M/dictGetKey">dictGetKey</a>(<a class="local col6 ref" href="#16de" title='de' data-ref="16de">de</a>);</td></tr>
<tr><th id="142">142</th><td></td></tr>
<tr><th id="143">143</th><td>        <b>if</b> (<a class="local col4 ref" href="#14event_to_reset" title='event_to_reset' data-ref="14event_to_reset">event_to_reset</a> == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span> || <a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col8 ref" href="#18event" title='event' data-ref="18event">event</a>,<a class="local col4 ref" href="#14event_to_reset" title='event_to_reset' data-ref="14event_to_reset">event_to_reset</a>) == <var>0</var>) {</td></tr>
<tr><th id="144">144</th><td>            <a class="ref fn" href="dict.h.html#dictDelete" title='dictDelete' data-ref="dictDelete">dictDelete</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>, <a class="local col8 ref" href="#18event" title='event' data-ref="18event">event</a>);</td></tr>
<tr><th id="145">145</th><td>            <a class="local col7 ref" href="#17resets" title='resets' data-ref="17resets">resets</a>++;</td></tr>
<tr><th id="146">146</th><td>        }</td></tr>
<tr><th id="147">147</th><td>    }</td></tr>
<tr><th id="148">148</th><td>    <a class="ref fn" href="dict.h.html#dictReleaseIterator" title='dictReleaseIterator' data-ref="dictReleaseIterator">dictReleaseIterator</a>(<a class="local col5 ref" href="#15di" title='di' data-ref="15di">di</a>);</td></tr>
<tr><th id="149">149</th><td>    <b>return</b> <a class="local col7 ref" href="#17resets" title='resets' data-ref="17resets">resets</a>;</td></tr>
<tr><th id="150">150</th><td>}</td></tr>
<tr><th id="151">151</th><td></td></tr>
<tr><th id="152">152</th><td><i>/* ------------------------ Latency reporting (doctor) ---------------------- */</i></td></tr>
<tr><th id="153">153</th><td></td></tr>
<tr><th id="154">154</th><td><i>/* Analyze the samples avaialble for a given event and return a structure</i></td></tr>
<tr><th id="155">155</th><td><i> * populate with different metrics, average, MAD, min, max, and so forth.</i></td></tr>
<tr><th id="156">156</th><td><i> * Check latency.h definition of struct latenctStat for more info.</i></td></tr>
<tr><th id="157">157</th><td><i> * If the specified event has no elements the structure is populate with</i></td></tr>
<tr><th id="158">158</th><td><i> * zero values. */</i></td></tr>
<tr><th id="159">159</th><td><em>void</em> <dfn class="decl def fn" id="analyzeLatencyForEvent" title='analyzeLatencyForEvent' data-ref="analyzeLatencyForEvent">analyzeLatencyForEvent</dfn>(<em>char</em> *<dfn class="local col9 decl" id="19event" title='event' data-type='char *' data-ref="19event">event</dfn>, <b>struct</b> <a class="type" href="latency.h.html#latencyStats" title='latencyStats' data-ref="latencyStats">latencyStats</a> *<dfn class="local col0 decl" id="20ls" title='ls' data-type='struct latencyStats *' data-ref="20ls">ls</dfn>) {</td></tr>
<tr><th id="160">160</th><td>    <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col1 decl" id="21ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="21ts">ts</dfn> = <a class="ref fn" href="dict.h.html#dictFetchValue" title='dictFetchValue' data-ref="dictFetchValue">dictFetchValue</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>,<a class="local col9 ref" href="#19event" title='event' data-ref="19event">event</a>);</td></tr>
<tr><th id="161">161</th><td>    <em>int</em> <dfn class="local col2 decl" id="22j" title='j' data-type='int' data-ref="22j">j</dfn>;</td></tr>
<tr><th id="162">162</th><td>    <a class="typedef" href="../../include/stdint.h.html#uint64_t" title='uint64_t' data-type='unsigned long' data-ref="uint64_t">uint64_t</a> <dfn class="local col3 decl" id="23sum" title='sum' data-type='uint64_t' data-ref="23sum">sum</dfn>;</td></tr>
<tr><th id="163">163</th><td></td></tr>
<tr><th id="164">164</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::all_time_high" title='latencyStats::all_time_high' data-ref="latencyStats::all_time_high">all_time_high</a> = <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a> ? <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a> : <var>0</var>;</td></tr>
<tr><th id="165">165</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::avg" title='latencyStats::avg' data-ref="latencyStats::avg">avg</a> = <var>0</var>;</td></tr>
<tr><th id="166">166</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::min" title='latencyStats::min' data-ref="latencyStats::min">min</a> = <var>0</var>;</td></tr>
<tr><th id="167">167</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::max" title='latencyStats::max' data-ref="latencyStats::max">max</a> = <var>0</var>;</td></tr>
<tr><th id="168">168</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::mad" title='latencyStats::mad' data-ref="latencyStats::mad">mad</a> = <var>0</var>;</td></tr>
<tr><th id="169">169</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a> = <var>0</var>;</td></tr>
<tr><th id="170">170</th><td>    <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a> = <var>0</var>;</td></tr>
<tr><th id="171">171</th><td>    <b>if</b> (!<a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>) <b>return</b>;</td></tr>
<tr><th id="172">172</th><td></td></tr>
<tr><th id="173">173</th><td>    <i>/* First pass, populate everything but the MAD. */</i></td></tr>
<tr><th id="174">174</th><td>    <a class="local col3 ref" href="#23sum" title='sum' data-ref="23sum">sum</a> = <var>0</var>;</td></tr>
<tr><th id="175">175</th><td>    <b>for</b> (<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a> = <var>0</var>; <a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a> &lt; <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>; <a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>++) {</td></tr>
<tr><th id="176">176</th><td>        <b>if</b> (<a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> == <var>0</var>) <b>continue</b>;</td></tr>
<tr><th id="177">177</th><td>        <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>++;</td></tr>
<tr><th id="178">178</th><td>        <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a> == <var>1</var>) {</td></tr>
<tr><th id="179">179</th><td>            <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::min" title='latencyStats::min' data-ref="latencyStats::min">min</a> = <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::max" title='latencyStats::max' data-ref="latencyStats::max">max</a> = <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="180">180</th><td>        } <b>else</b> {</td></tr>
<tr><th id="181">181</th><td>            <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::min" title='latencyStats::min' data-ref="latencyStats::min">min</a> &gt; <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>)</td></tr>
<tr><th id="182">182</th><td>                <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::min" title='latencyStats::min' data-ref="latencyStats::min">min</a> = <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="183">183</th><td>            <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::max" title='latencyStats::max' data-ref="latencyStats::max">max</a> &lt; <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>)</td></tr>
<tr><th id="184">184</th><td>                <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::max" title='latencyStats::max' data-ref="latencyStats::max">max</a> = <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="185">185</th><td>        }</td></tr>
<tr><th id="186">186</th><td>        <a class="local col3 ref" href="#23sum" title='sum' data-ref="23sum">sum</a> += <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="187">187</th><td></td></tr>
<tr><th id="188">188</th><td>        <i>/* Track the oldest event time in ls-&gt;period. */</i></td></tr>
<tr><th id="189">189</th><td>        <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a> == <var>0</var> || <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> &lt; <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a>)</td></tr>
<tr><th id="190">190</th><td>            <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a> = <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a>;</td></tr>
<tr><th id="191">191</th><td>    }</td></tr>
<tr><th id="192">192</th><td></td></tr>
<tr><th id="193">193</th><td>    <i>/* So far avg is actually the sum of the latencies, and period is</i></td></tr>
<tr><th id="194">194</th><td><i>     * the oldest event time. We need to make the first an average and</i></td></tr>
<tr><th id="195">195</th><td><i>     * the second a range of seconds. */</i></td></tr>
<tr><th id="196">196</th><td>    <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>) {</td></tr>
<tr><th id="197">197</th><td>        <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::avg" title='latencyStats::avg' data-ref="latencyStats::avg">avg</a> = <a class="local col3 ref" href="#23sum" title='sum' data-ref="23sum">sum</a> / <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>;</td></tr>
<tr><th id="198">198</th><td>        <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a> = <a class="ref fn" href="../../include/time.h.html#time" title='time' data-ref="time">time</a>(<span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) - <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a>;</td></tr>
<tr><th id="199">199</th><td>        <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a> == <var>0</var>) <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a> = <var>1</var>;</td></tr>
<tr><th id="200">200</th><td>    }</td></tr>
<tr><th id="201">201</th><td></td></tr>
<tr><th id="202">202</th><td>    <i>/* Second pass, compute MAD. */</i></td></tr>
<tr><th id="203">203</th><td>    <a class="local col3 ref" href="#23sum" title='sum' data-ref="23sum">sum</a> = <var>0</var>;</td></tr>
<tr><th id="204">204</th><td>    <b>for</b> (<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a> = <var>0</var>; <a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a> &lt; <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>; <a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>++) {</td></tr>
<tr><th id="205">205</th><td>        <a class="typedef" href="../../include/x86_64-linux-gnu/sys/types.h.html#197" title='int64_t' data-type='long' data-ref="int64_t">int64_t</a> <dfn class="local col4 decl" id="24delta" title='delta' data-type='int64_t' data-ref="24delta">delta</dfn>;</td></tr>
<tr><th id="206">206</th><td></td></tr>
<tr><th id="207">207</th><td>        <b>if</b> (<a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> == <var>0</var>) <b>continue</b>;</td></tr>
<tr><th id="208">208</th><td>        <a class="local col4 ref" href="#24delta" title='delta' data-ref="24delta">delta</a> = (<a class="typedef" href="../../include/x86_64-linux-gnu/sys/types.h.html#197" title='int64_t' data-type='long' data-ref="int64_t">int64_t</a>)<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::avg" title='latencyStats::avg' data-ref="latencyStats::avg">avg</a> - <a class="local col1 ref" href="#21ts" title='ts' data-ref="21ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col2 ref" href="#22j" title='j' data-ref="22j">j</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="209">209</th><td>        <b>if</b> (<a class="local col4 ref" href="#24delta" title='delta' data-ref="24delta">delta</a> &lt; <var>0</var>) <a class="local col4 ref" href="#24delta" title='delta' data-ref="24delta">delta</a> = -<a class="local col4 ref" href="#24delta" title='delta' data-ref="24delta">delta</a>;</td></tr>
<tr><th id="210">210</th><td>        <a class="local col3 ref" href="#23sum" title='sum' data-ref="23sum">sum</a> += <a class="local col4 ref" href="#24delta" title='delta' data-ref="24delta">delta</a>;</td></tr>
<tr><th id="211">211</th><td>    }</td></tr>
<tr><th id="212">212</th><td>    <b>if</b> (<a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>) <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::mad" title='latencyStats::mad' data-ref="latencyStats::mad">mad</a> = <a class="local col3 ref" href="#23sum" title='sum' data-ref="23sum">sum</a> / <a class="local col0 ref" href="#20ls" title='ls' data-ref="20ls">ls</a>-&gt;<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>;</td></tr>
<tr><th id="213">213</th><td>}</td></tr>
<tr><th id="214">214</th><td></td></tr>
<tr><th id="215">215</th><td><i>/* Create a human readable report of latency events for this Redis instance. */</i></td></tr>
<tr><th id="216">216</th><td><a class="typedef" href="sds.h.html#sds" title='sds' data-type='char *' data-ref="sds">sds</a> <dfn class="decl def fn" id="createLatencyReport" title='createLatencyReport' data-ref="createLatencyReport">createLatencyReport</dfn>(<em>void</em>) {</td></tr>
<tr><th id="217">217</th><td>    <a class="typedef" href="sds.h.html#sds" title='sds' data-type='char *' data-ref="sds">sds</a> <dfn class="local col5 decl" id="25report" title='report' data-type='sds' data-ref="25report">report</dfn> = <a class="ref fn" href="sds.h.html#sdsempty" title='sdsempty' data-ref="sdsempty">sdsempty</a>();</td></tr>
<tr><th id="218">218</th><td>    <em>int</em> <dfn class="local col6 decl" id="26advise_better_vm" title='advise_better_vm' data-type='int' data-ref="26advise_better_vm">advise_better_vm</dfn> = <var>0</var>;       <i>/* Better virtual machines. */</i></td></tr>
<tr><th id="219">219</th><td>    <em>int</em> <dfn class="local col7 decl" id="27advise_slowlog_enabled" title='advise_slowlog_enabled' data-type='int' data-ref="27advise_slowlog_enabled">advise_slowlog_enabled</dfn> = <var>0</var>; <i>/* Enable slowlog. */</i></td></tr>
<tr><th id="220">220</th><td>    <em>int</em> <dfn class="local col8 decl" id="28advise_slowlog_tuning" title='advise_slowlog_tuning' data-type='int' data-ref="28advise_slowlog_tuning">advise_slowlog_tuning</dfn> = <var>0</var>;  <i>/* Reconfigure slowlog. */</i></td></tr>
<tr><th id="221">221</th><td>    <em>int</em> <dfn class="local col9 decl" id="29advise_slowlog_inspect" title='advise_slowlog_inspect' data-type='int' data-ref="29advise_slowlog_inspect">advise_slowlog_inspect</dfn> = <var>0</var>; <i>/* Check your slowlog. */</i></td></tr>
<tr><th id="222">222</th><td>    <em>int</em> <dfn class="local col0 decl" id="30advise_disk_contention" title='advise_disk_contention' data-type='int' data-ref="30advise_disk_contention">advise_disk_contention</dfn> = <var>0</var>; <i>/* Try to lower disk contention. */</i></td></tr>
<tr><th id="223">223</th><td>    <em>int</em> <dfn class="local col1 decl" id="31advise_scheduler" title='advise_scheduler' data-type='int' data-ref="31advise_scheduler">advise_scheduler</dfn> = <var>0</var>;       <i>/* Intrinsic latency. */</i></td></tr>
<tr><th id="224">224</th><td>    <em>int</em> <dfn class="local col2 decl" id="32advise_data_writeback" title='advise_data_writeback' data-type='int' data-ref="32advise_data_writeback">advise_data_writeback</dfn> = <var>0</var>;  <i>/* data=writeback. */</i></td></tr>
<tr><th id="225">225</th><td>    <em>int</em> <dfn class="local col3 decl" id="33advise_no_appendfsync" title='advise_no_appendfsync' data-type='int' data-ref="33advise_no_appendfsync">advise_no_appendfsync</dfn> = <var>0</var>;  <i>/* don't fsync during rewrites. */</i></td></tr>
<tr><th id="226">226</th><td>    <em>int</em> <dfn class="local col4 decl" id="34advise_local_disk" title='advise_local_disk' data-type='int' data-ref="34advise_local_disk">advise_local_disk</dfn> = <var>0</var>;      <i>/* Avoid remote disks. */</i></td></tr>
<tr><th id="227">227</th><td>    <em>int</em> <dfn class="local col5 decl" id="35advise_ssd" title='advise_ssd' data-type='int' data-ref="35advise_ssd">advise_ssd</dfn> = <var>0</var>;             <i>/* Use an SSD drive. */</i></td></tr>
<tr><th id="228">228</th><td>    <em>int</em> <dfn class="local col6 decl" id="36advise_write_load_info" title='advise_write_load_info' data-type='int' data-ref="36advise_write_load_info">advise_write_load_info</dfn> = <var>0</var>; <i>/* Print info about AOF and write load. */</i></td></tr>
<tr><th id="229">229</th><td>    <em>int</em> <dfn class="local col7 decl" id="37advise_hz" title='advise_hz' data-type='int' data-ref="37advise_hz">advise_hz</dfn> = <var>0</var>;              <i>/* Use higher HZ. */</i></td></tr>
<tr><th id="230">230</th><td>    <em>int</em> <dfn class="local col8 decl" id="38advise_large_objects" title='advise_large_objects' data-type='int' data-ref="38advise_large_objects">advise_large_objects</dfn> = <var>0</var>;   <i>/* Deletion of large objects. */</i></td></tr>
<tr><th id="231">231</th><td>    <em>int</em> <dfn class="local col9 decl" id="39advise_mass_eviction" title='advise_mass_eviction' data-type='int' data-ref="39advise_mass_eviction">advise_mass_eviction</dfn> = <var>0</var>;   <i>/* Avoid mass eviction of keys. */</i></td></tr>
<tr><th id="232">232</th><td>    <em>int</em> <dfn class="local col0 decl" id="40advise_relax_fsync_policy" title='advise_relax_fsync_policy' data-type='int' data-ref="40advise_relax_fsync_policy">advise_relax_fsync_policy</dfn> = <var>0</var>; <i>/* appendfsync always is slow. */</i></td></tr>
<tr><th id="233">233</th><td>    <em>int</em> <dfn class="local col1 decl" id="41advise_disable_thp" title='advise_disable_thp' data-type='int' data-ref="41advise_disable_thp">advise_disable_thp</dfn> = <var>0</var>;     <i>/* AnonHugePages detected. */</i></td></tr>
<tr><th id="234">234</th><td>    <em>int</em> <dfn class="local col2 decl" id="42advices" title='advices' data-type='int' data-ref="42advices">advices</dfn> = <var>0</var>;</td></tr>
<tr><th id="235">235</th><td></td></tr>
<tr><th id="236">236</th><td>    <i>/* Return ASAP if the latency engine is disabled and it looks like it</i></td></tr>
<tr><th id="237">237</th><td><i>     * was never enabled so far. */</i></td></tr>
<tr><th id="238">238</th><td>    <b>if</b> (<a class="macro" href="dict.h.html#146" title="((server.latency_events)-&gt;ht[0].used+(server.latency_events)-&gt;ht[1].used)" data-ref="_M/dictSize">dictSize</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>) == <var>0</var> &amp;&amp;</td></tr>
<tr><th id="239">239</th><td>        <a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_monitor_threshold" title='redisServer::latency_monitor_threshold' data-ref="redisServer::latency_monitor_threshold">latency_monitor_threshold</a> == <var>0</var>)</td></tr>
<tr><th id="240">240</th><td>    {</td></tr>
<tr><th id="241">241</th><td>        <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"I'm sorry, Dave, I can't do that. Latency monitoring is disabled in this Redis instance. You may use \"CONFIG SET latency-monitor-threshold &lt;milliseconds&gt;.\" in order to enable it. If we weren't in a deep space mission I'd suggest to take a look at http://redis.io/topics/latency-monitor.\n"</q>);</td></tr>
<tr><th id="242">242</th><td>        <b>return</b> <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>;</td></tr>
<tr><th id="243">243</th><td>    }</td></tr>
<tr><th id="244">244</th><td></td></tr>
<tr><th id="245">245</th><td>    <i>/* Show all the events stats and add for each event some event-related</i></td></tr>
<tr><th id="246">246</th><td><i>     * comment depending on the values. */</i></td></tr>
<tr><th id="247">247</th><td>    <a class="typedef" href="dict.h.html#dictIterator" title='dictIterator' data-type='struct dictIterator' data-ref="dictIterator">dictIterator</a> *<dfn class="local col3 decl" id="43di" title='di' data-type='dictIterator *' data-ref="43di">di</dfn>;</td></tr>
<tr><th id="248">248</th><td>    <a class="typedef" href="dict.h.html#dictEntry" title='dictEntry' data-type='struct dictEntry' data-ref="dictEntry">dictEntry</a> *<dfn class="local col4 decl" id="44de" title='de' data-type='dictEntry *' data-ref="44de">de</dfn>;</td></tr>
<tr><th id="249">249</th><td>    <em>int</em> <dfn class="local col5 decl" id="45eventnum" title='eventnum' data-type='int' data-ref="45eventnum">eventnum</dfn> = <var>0</var>;</td></tr>
<tr><th id="250">250</th><td></td></tr>
<tr><th id="251">251</th><td>    <a class="local col3 ref" href="#43di" title='di' data-ref="43di">di</a> = <a class="ref fn" href="dict.h.html#dictGetSafeIterator" title='dictGetSafeIterator' data-ref="dictGetSafeIterator">dictGetSafeIterator</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>);</td></tr>
<tr><th id="252">252</th><td>    <b>while</b>((<a class="local col4 ref" href="#44de" title='de' data-ref="44de">de</a> = <a class="ref fn" href="dict.h.html#dictNext" title='dictNext' data-ref="dictNext">dictNext</a>(<a class="local col3 ref" href="#43di" title='di' data-ref="43di">di</a>)) != <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) {</td></tr>
<tr><th id="253">253</th><td>        <em>char</em> *<dfn class="local col6 decl" id="46event" title='event' data-type='char *' data-ref="46event">event</dfn> = <a class="macro" href="dict.h.html#140" title="((de)-&gt;key)" data-ref="_M/dictGetKey">dictGetKey</a>(<a class="local col4 ref" href="#44de" title='de' data-ref="44de">de</a>);</td></tr>
<tr><th id="254">254</th><td>        <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col7 decl" id="47ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="47ts">ts</dfn> = <a class="macro" href="dict.h.html#141" title="((de)-&gt;v.val)" data-ref="_M/dictGetVal">dictGetVal</a>(<a class="local col4 ref" href="#44de" title='de' data-ref="44de">de</a>);</td></tr>
<tr><th id="255">255</th><td>        <b>struct</b> <a class="type" href="latency.h.html#latencyStats" title='latencyStats' data-ref="latencyStats">latencyStats</a> <dfn class="local col8 decl" id="48ls" title='ls' data-type='struct latencyStats' data-ref="48ls">ls</dfn>;</td></tr>
<tr><th id="256">256</th><td></td></tr>
<tr><th id="257">257</th><td>        <b>if</b> (<a class="local col7 ref" href="#47ts" title='ts' data-ref="47ts">ts</a> == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) <b>continue</b>;</td></tr>
<tr><th id="258">258</th><td>        <a class="local col5 ref" href="#45eventnum" title='eventnum' data-ref="45eventnum">eventnum</a>++;</td></tr>
<tr><th id="259">259</th><td>        <b>if</b> (<a class="local col5 ref" href="#45eventnum" title='eventnum' data-ref="45eventnum">eventnum</a> == <var>1</var>) {</td></tr>
<tr><th id="260">260</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"Dave, I have observed latency spikes in this Redis instance. You don't mind talking about it, do you Dave?\n\n"</q>);</td></tr>
<tr><th id="261">261</th><td>        }</td></tr>
<tr><th id="262">262</th><td>        <a class="ref fn" href="#analyzeLatencyForEvent" title='analyzeLatencyForEvent' data-ref="analyzeLatencyForEvent">analyzeLatencyForEvent</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,&amp;<a class="local col8 ref" href="#48ls" title='ls' data-ref="48ls">ls</a>);</td></tr>
<tr><th id="263">263</th><td></td></tr>
<tr><th id="264">264</th><td>        <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscatprintf" title='sdscatprintf' data-ref="sdscatprintf">sdscatprintf</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,</td></tr>
<tr><th id="265">265</th><td>            <q>"%d. %s: %d latency spikes (average %lums, mean deviation %lums, period %.2f sec). Worst all time event %lums."</q>,</td></tr>
<tr><th id="266">266</th><td>            <a class="local col5 ref" href="#45eventnum" title='eventnum' data-ref="45eventnum">eventnum</a>, <a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,</td></tr>
<tr><th id="267">267</th><td>            <a class="local col8 ref" href="#48ls" title='ls' data-ref="48ls">ls</a>.<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>,</td></tr>
<tr><th id="268">268</th><td>            (<em>unsigned</em> <em>long</em>) <a class="local col8 ref" href="#48ls" title='ls' data-ref="48ls">ls</a>.<a class="ref field" href="latency.h.html#latencyStats::avg" title='latencyStats::avg' data-ref="latencyStats::avg">avg</a>,</td></tr>
<tr><th id="269">269</th><td>            (<em>unsigned</em> <em>long</em>) <a class="local col8 ref" href="#48ls" title='ls' data-ref="48ls">ls</a>.<a class="ref field" href="latency.h.html#latencyStats::mad" title='latencyStats::mad' data-ref="latencyStats::mad">mad</a>,</td></tr>
<tr><th id="270">270</th><td>            (<em>double</em>) <a class="local col8 ref" href="#48ls" title='ls' data-ref="48ls">ls</a>.<a class="ref field" href="latency.h.html#latencyStats::period" title='latencyStats::period' data-ref="latencyStats::period">period</a>/<a class="local col8 ref" href="#48ls" title='ls' data-ref="48ls">ls</a>.<a class="ref field" href="latency.h.html#latencyStats::samples" title='latencyStats::samples' data-ref="latencyStats::samples">samples</a>,</td></tr>
<tr><th id="271">271</th><td>            (<em>unsigned</em> <em>long</em>) <a class="local col7 ref" href="#47ts" title='ts' data-ref="47ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a>);</td></tr>
<tr><th id="272">272</th><td></td></tr>
<tr><th id="273">273</th><td>        <i>/* Fork */</i></td></tr>
<tr><th id="274">274</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"fork"</q>)) {</td></tr>
<tr><th id="275">275</th><td>            <em>char</em> *<dfn class="local col9 decl" id="49fork_quality" title='fork_quality' data-type='char *' data-ref="49fork_quality">fork_quality</dfn>;</td></tr>
<tr><th id="276">276</th><td>            <b>if</b> (<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::stat_fork_rate" title='redisServer::stat_fork_rate' data-ref="redisServer::stat_fork_rate">stat_fork_rate</a> &lt; <var>10</var>) {</td></tr>
<tr><th id="277">277</th><td>                <a class="local col9 ref" href="#49fork_quality" title='fork_quality' data-ref="49fork_quality">fork_quality</a> = <q>"terrible"</q>;</td></tr>
<tr><th id="278">278</th><td>                <a class="local col6 ref" href="#26advise_better_vm" title='advise_better_vm' data-ref="26advise_better_vm">advise_better_vm</a> = <var>1</var>;</td></tr>
<tr><th id="279">279</th><td>                <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="280">280</th><td>            } <b>else</b> <b>if</b> (<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::stat_fork_rate" title='redisServer::stat_fork_rate' data-ref="redisServer::stat_fork_rate">stat_fork_rate</a> &lt; <var>25</var>) {</td></tr>
<tr><th id="281">281</th><td>                <a class="local col9 ref" href="#49fork_quality" title='fork_quality' data-ref="49fork_quality">fork_quality</a> = <q>"poor"</q>;</td></tr>
<tr><th id="282">282</th><td>                <a class="local col6 ref" href="#26advise_better_vm" title='advise_better_vm' data-ref="26advise_better_vm">advise_better_vm</a> = <var>1</var>;</td></tr>
<tr><th id="283">283</th><td>                <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="284">284</th><td>            } <b>else</b> <b>if</b> (<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::stat_fork_rate" title='redisServer::stat_fork_rate' data-ref="redisServer::stat_fork_rate">stat_fork_rate</a> &lt; <var>100</var>) {</td></tr>
<tr><th id="285">285</th><td>                <a class="local col9 ref" href="#49fork_quality" title='fork_quality' data-ref="49fork_quality">fork_quality</a> = <q>"good"</q>;</td></tr>
<tr><th id="286">286</th><td>            } <b>else</b> {</td></tr>
<tr><th id="287">287</th><td>                <a class="local col9 ref" href="#49fork_quality" title='fork_quality' data-ref="49fork_quality">fork_quality</a> = <q>"excellent"</q>;</td></tr>
<tr><th id="288">288</th><td>            }</td></tr>
<tr><th id="289">289</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscatprintf" title='sdscatprintf' data-ref="sdscatprintf">sdscatprintf</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,</td></tr>
<tr><th id="290">290</th><td>                <q>" Fork rate is %.2f GB/sec (%s)."</q>, <a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::stat_fork_rate" title='redisServer::stat_fork_rate' data-ref="redisServer::stat_fork_rate">stat_fork_rate</a>,</td></tr>
<tr><th id="291">291</th><td>                <a class="local col9 ref" href="#49fork_quality" title='fork_quality' data-ref="49fork_quality">fork_quality</a>);</td></tr>
<tr><th id="292">292</th><td>        }</td></tr>
<tr><th id="293">293</th><td></td></tr>
<tr><th id="294">294</th><td>        <i>/* Potentially commands. */</i></td></tr>
<tr><th id="295">295</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"command"</q>)) {</td></tr>
<tr><th id="296">296</th><td>            <b>if</b> (<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::slowlog_log_slower_than" title='redisServer::slowlog_log_slower_than' data-ref="redisServer::slowlog_log_slower_than">slowlog_log_slower_than</a> == <var>0</var>) {</td></tr>
<tr><th id="297">297</th><td>                <a class="local col7 ref" href="#27advise_slowlog_enabled" title='advise_slowlog_enabled' data-ref="27advise_slowlog_enabled">advise_slowlog_enabled</a> = <var>1</var>;</td></tr>
<tr><th id="298">298</th><td>                <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="299">299</th><td>            } <b>else</b> <b>if</b> (<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::slowlog_log_slower_than" title='redisServer::slowlog_log_slower_than' data-ref="redisServer::slowlog_log_slower_than">slowlog_log_slower_than</a>/<var>1000</var> &gt;</td></tr>
<tr><th id="300">300</th><td>                       <a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_monitor_threshold" title='redisServer::latency_monitor_threshold' data-ref="redisServer::latency_monitor_threshold">latency_monitor_threshold</a>)</td></tr>
<tr><th id="301">301</th><td>            {</td></tr>
<tr><th id="302">302</th><td>                <a class="local col8 ref" href="#28advise_slowlog_tuning" title='advise_slowlog_tuning' data-ref="28advise_slowlog_tuning">advise_slowlog_tuning</a> = <var>1</var>;</td></tr>
<tr><th id="303">303</th><td>                <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="304">304</th><td>            }</td></tr>
<tr><th id="305">305</th><td>            <a class="local col9 ref" href="#29advise_slowlog_inspect" title='advise_slowlog_inspect' data-ref="29advise_slowlog_inspect">advise_slowlog_inspect</a> = <var>1</var>;</td></tr>
<tr><th id="306">306</th><td>            <a class="local col8 ref" href="#38advise_large_objects" title='advise_large_objects' data-ref="38advise_large_objects">advise_large_objects</a> = <var>1</var>;</td></tr>
<tr><th id="307">307</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>2</var>;</td></tr>
<tr><th id="308">308</th><td>        }</td></tr>
<tr><th id="309">309</th><td></td></tr>
<tr><th id="310">310</th><td>        <i>/* fast-command. */</i></td></tr>
<tr><th id="311">311</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"fast-command"</q>)) {</td></tr>
<tr><th id="312">312</th><td>            <a class="local col1 ref" href="#31advise_scheduler" title='advise_scheduler' data-ref="31advise_scheduler">advise_scheduler</a> = <var>1</var>;</td></tr>
<tr><th id="313">313</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="314">314</th><td>        }</td></tr>
<tr><th id="315">315</th><td></td></tr>
<tr><th id="316">316</th><td>        <i>/* AOF and I/O. */</i></td></tr>
<tr><th id="317">317</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-write-pending-fsync"</q>)) {</td></tr>
<tr><th id="318">318</th><td>            <a class="local col4 ref" href="#34advise_local_disk" title='advise_local_disk' data-ref="34advise_local_disk">advise_local_disk</a> = <var>1</var>;</td></tr>
<tr><th id="319">319</th><td>            <a class="local col0 ref" href="#30advise_disk_contention" title='advise_disk_contention' data-ref="30advise_disk_contention">advise_disk_contention</a> = <var>1</var>;</td></tr>
<tr><th id="320">320</th><td>            <a class="local col5 ref" href="#35advise_ssd" title='advise_ssd' data-ref="35advise_ssd">advise_ssd</a> = <var>1</var>;</td></tr>
<tr><th id="321">321</th><td>            <a class="local col2 ref" href="#32advise_data_writeback" title='advise_data_writeback' data-ref="32advise_data_writeback">advise_data_writeback</a> = <var>1</var>;</td></tr>
<tr><th id="322">322</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>4</var>;</td></tr>
<tr><th id="323">323</th><td>        }</td></tr>
<tr><th id="324">324</th><td></td></tr>
<tr><th id="325">325</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-write-active-child"</q>)) {</td></tr>
<tr><th id="326">326</th><td>            <a class="local col3 ref" href="#33advise_no_appendfsync" title='advise_no_appendfsync' data-ref="33advise_no_appendfsync">advise_no_appendfsync</a> = <var>1</var>;</td></tr>
<tr><th id="327">327</th><td>            <a class="local col2 ref" href="#32advise_data_writeback" title='advise_data_writeback' data-ref="32advise_data_writeback">advise_data_writeback</a> = <var>1</var>;</td></tr>
<tr><th id="328">328</th><td>            <a class="local col5 ref" href="#35advise_ssd" title='advise_ssd' data-ref="35advise_ssd">advise_ssd</a> = <var>1</var>;</td></tr>
<tr><th id="329">329</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>3</var>;</td></tr>
<tr><th id="330">330</th><td>        }</td></tr>
<tr><th id="331">331</th><td></td></tr>
<tr><th id="332">332</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-write-alone"</q>)) {</td></tr>
<tr><th id="333">333</th><td>            <a class="local col4 ref" href="#34advise_local_disk" title='advise_local_disk' data-ref="34advise_local_disk">advise_local_disk</a> = <var>1</var>;</td></tr>
<tr><th id="334">334</th><td>            <a class="local col2 ref" href="#32advise_data_writeback" title='advise_data_writeback' data-ref="32advise_data_writeback">advise_data_writeback</a> = <var>1</var>;</td></tr>
<tr><th id="335">335</th><td>            <a class="local col5 ref" href="#35advise_ssd" title='advise_ssd' data-ref="35advise_ssd">advise_ssd</a> = <var>1</var>;</td></tr>
<tr><th id="336">336</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>3</var>;</td></tr>
<tr><th id="337">337</th><td>        }</td></tr>
<tr><th id="338">338</th><td></td></tr>
<tr><th id="339">339</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-fsync-always"</q>)) {</td></tr>
<tr><th id="340">340</th><td>            <a class="local col0 ref" href="#40advise_relax_fsync_policy" title='advise_relax_fsync_policy' data-ref="40advise_relax_fsync_policy">advise_relax_fsync_policy</a> = <var>1</var>;</td></tr>
<tr><th id="341">341</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="342">342</th><td>        }</td></tr>
<tr><th id="343">343</th><td></td></tr>
<tr><th id="344">344</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-fstat"</q>) ||</td></tr>
<tr><th id="345">345</th><td>            !<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"rdb-unlik-temp-file"</q>)) {</td></tr>
<tr><th id="346">346</th><td>            <a class="local col0 ref" href="#30advise_disk_contention" title='advise_disk_contention' data-ref="30advise_disk_contention">advise_disk_contention</a> = <var>1</var>;</td></tr>
<tr><th id="347">347</th><td>            <a class="local col4 ref" href="#34advise_local_disk" title='advise_local_disk' data-ref="34advise_local_disk">advise_local_disk</a> = <var>1</var>;</td></tr>
<tr><th id="348">348</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>2</var>;</td></tr>
<tr><th id="349">349</th><td>        }</td></tr>
<tr><th id="350">350</th><td></td></tr>
<tr><th id="351">351</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-rewrite-diff-write"</q>) ||</td></tr>
<tr><th id="352">352</th><td>            !<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"aof-rename"</q>)) {</td></tr>
<tr><th id="353">353</th><td>            <a class="local col6 ref" href="#36advise_write_load_info" title='advise_write_load_info' data-ref="36advise_write_load_info">advise_write_load_info</a> = <var>1</var>;</td></tr>
<tr><th id="354">354</th><td>            <a class="local col2 ref" href="#32advise_data_writeback" title='advise_data_writeback' data-ref="32advise_data_writeback">advise_data_writeback</a> = <var>1</var>;</td></tr>
<tr><th id="355">355</th><td>            <a class="local col5 ref" href="#35advise_ssd" title='advise_ssd' data-ref="35advise_ssd">advise_ssd</a> = <var>1</var>;</td></tr>
<tr><th id="356">356</th><td>            <a class="local col4 ref" href="#34advise_local_disk" title='advise_local_disk' data-ref="34advise_local_disk">advise_local_disk</a> = <var>1</var>;</td></tr>
<tr><th id="357">357</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>4</var>;</td></tr>
<tr><th id="358">358</th><td>        }</td></tr>
<tr><th id="359">359</th><td></td></tr>
<tr><th id="360">360</th><td>        <i>/* Expire cycle. */</i></td></tr>
<tr><th id="361">361</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"expire-cycle"</q>)) {</td></tr>
<tr><th id="362">362</th><td>            <a class="local col7 ref" href="#37advise_hz" title='advise_hz' data-ref="37advise_hz">advise_hz</a> = <var>1</var>;</td></tr>
<tr><th id="363">363</th><td>            <a class="local col8 ref" href="#38advise_large_objects" title='advise_large_objects' data-ref="38advise_large_objects">advise_large_objects</a> = <var>1</var>;</td></tr>
<tr><th id="364">364</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> += <var>2</var>;</td></tr>
<tr><th id="365">365</th><td>        }</td></tr>
<tr><th id="366">366</th><td></td></tr>
<tr><th id="367">367</th><td>        <i>/* Eviction cycle. */</i></td></tr>
<tr><th id="368">368</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"eviction-del"</q>)) {</td></tr>
<tr><th id="369">369</th><td>            <a class="local col8 ref" href="#38advise_large_objects" title='advise_large_objects' data-ref="38advise_large_objects">advise_large_objects</a> = <var>1</var>;</td></tr>
<tr><th id="370">370</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="371">371</th><td>        }</td></tr>
<tr><th id="372">372</th><td></td></tr>
<tr><th id="373">373</th><td>        <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col6 ref" href="#46event" title='event' data-ref="46event">event</a>,<q>"eviction-cycle"</q>)) {</td></tr>
<tr><th id="374">374</th><td>            <a class="local col9 ref" href="#39advise_mass_eviction" title='advise_mass_eviction' data-ref="39advise_mass_eviction">advise_mass_eviction</a> = <var>1</var>;</td></tr>
<tr><th id="375">375</th><td>            <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="376">376</th><td>        }</td></tr>
<tr><th id="377">377</th><td></td></tr>
<tr><th id="378">378</th><td>        <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscatlen" title='sdscatlen' data-ref="sdscatlen">sdscatlen</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"\n"</q>,<var>1</var>);</td></tr>
<tr><th id="379">379</th><td>    }</td></tr>
<tr><th id="380">380</th><td>    <a class="ref fn" href="dict.h.html#dictReleaseIterator" title='dictReleaseIterator' data-ref="dictReleaseIterator">dictReleaseIterator</a>(<a class="local col3 ref" href="#43di" title='di' data-ref="43di">di</a>);</td></tr>
<tr><th id="381">381</th><td></td></tr>
<tr><th id="382">382</th><td>    <i>/* Add non event based advices. */</i></td></tr>
<tr><th id="383">383</th><td>    <b>if</b> (<a class="ref fn" href="#THPGetAnonHugePagesSize" title='THPGetAnonHugePagesSize' data-ref="THPGetAnonHugePagesSize">THPGetAnonHugePagesSize</a>() &gt; <var>0</var>) {</td></tr>
<tr><th id="384">384</th><td>        <a class="local col1 ref" href="#41advise_disable_thp" title='advise_disable_thp' data-ref="41advise_disable_thp">advise_disable_thp</a> = <var>1</var>;</td></tr>
<tr><th id="385">385</th><td>        <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a>++;</td></tr>
<tr><th id="386">386</th><td>    }</td></tr>
<tr><th id="387">387</th><td></td></tr>
<tr><th id="388">388</th><td>    <b>if</b> (<a class="local col5 ref" href="#45eventnum" title='eventnum' data-ref="45eventnum">eventnum</a> == <var>0</var> &amp;&amp; <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> == <var>0</var>) {</td></tr>
<tr><th id="389">389</th><td>        <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"Dave, no latency spike was observed during the lifetime of this Redis instance, not in the slightest bit. I honestly think you ought to sit down calmly, take a stress pill, and think things over.\n"</q>);</td></tr>
<tr><th id="390">390</th><td>    } <b>else</b> <b>if</b> (<a class="local col5 ref" href="#45eventnum" title='eventnum' data-ref="45eventnum">eventnum</a> &gt; <var>0</var> &amp;&amp; <a class="local col2 ref" href="#42advices" title='advices' data-ref="42advices">advices</a> == <var>0</var>) {</td></tr>
<tr><th id="391">391</th><td>        <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"\nWhile there are latency events logged, I'm not able to suggest any easy fix. Please use the Redis community to get some help, providing this report in your help request.\n"</q>);</td></tr>
<tr><th id="392">392</th><td>    } <b>else</b> {</td></tr>
<tr><th id="393">393</th><td>        <i>/* Add all the suggestions accumulated so far. */</i></td></tr>
<tr><th id="394">394</th><td></td></tr>
<tr><th id="395">395</th><td>        <i>/* Better VM. */</i></td></tr>
<tr><th id="396">396</th><td>        <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"\nI have a few advices for you:\n\n"</q>);</td></tr>
<tr><th id="397">397</th><td>        <b>if</b> (<a class="local col6 ref" href="#26advise_better_vm" title='advise_better_vm' data-ref="26advise_better_vm">advise_better_vm</a>) {</td></tr>
<tr><th id="398">398</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- If you are using a virtual machine, consider upgrading it with a faster one using an hypervisior that provides less latency during fork() calls. Xen is known to have poor fork() performance. Even in the context of the same VM provider, certain kinds of instances can execute fork faster than others.\n"</q>);</td></tr>
<tr><th id="399">399</th><td>        }</td></tr>
<tr><th id="400">400</th><td></td></tr>
<tr><th id="401">401</th><td>        <i>/* Slow log. */</i></td></tr>
<tr><th id="402">402</th><td>        <b>if</b> (<a class="local col7 ref" href="#27advise_slowlog_enabled" title='advise_slowlog_enabled' data-ref="27advise_slowlog_enabled">advise_slowlog_enabled</a>) {</td></tr>
<tr><th id="403">403</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscatprintf" title='sdscatprintf' data-ref="sdscatprintf">sdscatprintf</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- There are latency issues with potentially slow commands you are using. Try to enable the Slow Log Redis feature using the command 'CONFIG SET slowlog-log-slower-than %llu'. If the Slow log is disabled Redis is not able to log slow commands execution for you.\n"</q>, (<em>unsigned</em> <em>long</em> <em>long</em>)<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_monitor_threshold" title='redisServer::latency_monitor_threshold' data-ref="redisServer::latency_monitor_threshold">latency_monitor_threshold</a>*<var>1000</var>);</td></tr>
<tr><th id="404">404</th><td>        }</td></tr>
<tr><th id="405">405</th><td></td></tr>
<tr><th id="406">406</th><td>        <b>if</b> (<a class="local col8 ref" href="#28advise_slowlog_tuning" title='advise_slowlog_tuning' data-ref="28advise_slowlog_tuning">advise_slowlog_tuning</a>) {</td></tr>
<tr><th id="407">407</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscatprintf" title='sdscatprintf' data-ref="sdscatprintf">sdscatprintf</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Your current Slow Log configuration only logs events that are slower than your configured latency monitor threshold. Please use 'CONFIG SET slowlog-log-slower-than %llu'.\n"</q>, (<em>unsigned</em> <em>long</em> <em>long</em>)<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_monitor_threshold" title='redisServer::latency_monitor_threshold' data-ref="redisServer::latency_monitor_threshold">latency_monitor_threshold</a>*<var>1000</var>);</td></tr>
<tr><th id="408">408</th><td>        }</td></tr>
<tr><th id="409">409</th><td></td></tr>
<tr><th id="410">410</th><td>        <b>if</b> (<a class="local col9 ref" href="#29advise_slowlog_inspect" title='advise_slowlog_inspect' data-ref="29advise_slowlog_inspect">advise_slowlog_inspect</a>) {</td></tr>
<tr><th id="411">411</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Check your Slow Log to understand what are the commands you are running which are too slow to execute. Please check http://redis.io/commands/slowlog for more information.\n"</q>);</td></tr>
<tr><th id="412">412</th><td>        }</td></tr>
<tr><th id="413">413</th><td></td></tr>
<tr><th id="414">414</th><td>        <i>/* Intrinsic latency. */</i></td></tr>
<tr><th id="415">415</th><td>        <b>if</b> (<a class="local col1 ref" href="#31advise_scheduler" title='advise_scheduler' data-ref="31advise_scheduler">advise_scheduler</a>) {</td></tr>
<tr><th id="416">416</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- The system is slow to execute Redis code paths not containing system calls. This usually means the system does not provide Redis CPU time to run for long periods. You should try to:\n"</q></td></tr>
<tr><th id="417">417</th><td>            <q>"  1) Lower the system load.\n"</q></td></tr>
<tr><th id="418">418</th><td>            <q>"  2) Use a computer / VM just for Redis if you are running other softawre in the same system.\n"</q></td></tr>
<tr><th id="419">419</th><td>            <q>"  3) Check if you have a \"noisy neighbour\" problem.\n"</q></td></tr>
<tr><th id="420">420</th><td>            <q>"  4) Check with 'redis-cli --intrinsic-latency 100' what is the intrinsic latency in your system.\n"</q></td></tr>
<tr><th id="421">421</th><td>            <q>"  5) Check if the problem is allocator-related by recompiling Redis with MALLOC=libc, if you are using Jemalloc. However this may create fragmentation problems.\n"</q>);</td></tr>
<tr><th id="422">422</th><td>        }</td></tr>
<tr><th id="423">423</th><td></td></tr>
<tr><th id="424">424</th><td>        <i>/* AOF / Disk latency. */</i></td></tr>
<tr><th id="425">425</th><td>        <b>if</b> (<a class="local col4 ref" href="#34advise_local_disk" title='advise_local_disk' data-ref="34advise_local_disk">advise_local_disk</a>) {</td></tr>
<tr><th id="426">426</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- It is strongly advised to use local disks for persistence, especially if you are using AOF. Remote disks provided by platform-as-a-service providers are known to be slow.\n"</q>);</td></tr>
<tr><th id="427">427</th><td>        }</td></tr>
<tr><th id="428">428</th><td></td></tr>
<tr><th id="429">429</th><td>        <b>if</b> (<a class="local col5 ref" href="#35advise_ssd" title='advise_ssd' data-ref="35advise_ssd">advise_ssd</a>) {</td></tr>
<tr><th id="430">430</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- SSD disks are able to reduce fsync latency, and total time needed for snapshotting and AOF log rewriting (resulting in smaller memory usage and smaller final AOF rewrite buffer flushes). With extremely high write load SSD disks can be a good option. However Redis should perform reasonably with high load using normal disks. Use this advice as a last resort.\n"</q>);</td></tr>
<tr><th id="431">431</th><td>        }</td></tr>
<tr><th id="432">432</th><td></td></tr>
<tr><th id="433">433</th><td>        <b>if</b> (<a class="local col2 ref" href="#32advise_data_writeback" title='advise_data_writeback' data-ref="32advise_data_writeback">advise_data_writeback</a>) {</td></tr>
<tr><th id="434">434</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Mounting ext3/4 filesystems with data=writeback can provide a performance boost compared to data=ordered, however this mode of operation provides less guarantees, and sometimes it can happen that after a hard crash the AOF file will have an half-written command at the end and will require to be repaired before Redis restarts.\n"</q>);</td></tr>
<tr><th id="435">435</th><td>        }</td></tr>
<tr><th id="436">436</th><td></td></tr>
<tr><th id="437">437</th><td>        <b>if</b> (<a class="local col0 ref" href="#30advise_disk_contention" title='advise_disk_contention' data-ref="30advise_disk_contention">advise_disk_contention</a>) {</td></tr>
<tr><th id="438">438</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Try to lower the disk contention. This is often caused by other disk intensive processes running in the same computer (including other Redis instances).\n"</q>);</td></tr>
<tr><th id="439">439</th><td>        }</td></tr>
<tr><th id="440">440</th><td></td></tr>
<tr><th id="441">441</th><td>        <b>if</b> (<a class="local col3 ref" href="#33advise_no_appendfsync" title='advise_no_appendfsync' data-ref="33advise_no_appendfsync">advise_no_appendfsync</a>) {</td></tr>
<tr><th id="442">442</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Assuming from the point of view of data safety this is viable in your environment, you could try to enable the 'no-appendfsync-on-rewrite' option, so that fsync will not be performed while there is a child rewriting the AOF file or producing an RDB file (the moment where there is high disk contention).\n"</q>);</td></tr>
<tr><th id="443">443</th><td>        }</td></tr>
<tr><th id="444">444</th><td></td></tr>
<tr><th id="445">445</th><td>        <b>if</b> (<a class="local col0 ref" href="#40advise_relax_fsync_policy" title='advise_relax_fsync_policy' data-ref="40advise_relax_fsync_policy">advise_relax_fsync_policy</a> &amp;&amp; <a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="macro" href="config.h.html#87" title="fdatasync" data-ref="_M/aof_fsync">aof_fsync</a> == <a class="macro" href="redis.h.html#316" title="1" data-ref="_M/AOF_FSYNC_ALWAYS">AOF_FSYNC_ALWAYS</a>) {</td></tr>
<tr><th id="446">446</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Your fsync policy is set to 'always'. It is very hard to get good performances with such a setup, if possible try to relax the fsync policy to 'onesec'.\n"</q>);</td></tr>
<tr><th id="447">447</th><td>        }</td></tr>
<tr><th id="448">448</th><td></td></tr>
<tr><th id="449">449</th><td>        <b>if</b> (<a class="local col6 ref" href="#36advise_write_load_info" title='advise_write_load_info' data-ref="36advise_write_load_info">advise_write_load_info</a>) {</td></tr>
<tr><th id="450">450</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Latency during the AOF atomic rename operation or when the final difference is flushed to the AOF file at the end of the rewrite, sometimes is caused by very high write load, causing the AOF buffer to get very large. If possible try to send less commands to accomplish the same work, or use Lua scripts to group multiple operations into a single EVALSHA call.\n"</q>);</td></tr>
<tr><th id="451">451</th><td>        }</td></tr>
<tr><th id="452">452</th><td></td></tr>
<tr><th id="453">453</th><td>        <b>if</b> (<a class="local col7 ref" href="#37advise_hz" title='advise_hz' data-ref="37advise_hz">advise_hz</a> &amp;&amp; <a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::hz" title='redisServer::hz' data-ref="redisServer::hz">hz</a> &lt; <var>100</var>) {</td></tr>
<tr><th id="454">454</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- In order to make the Redis keys expiring process more incremental, try to set the 'hz' configuration parameter to 100 using 'CONFIG SET hz 100'.\n"</q>);</td></tr>
<tr><th id="455">455</th><td>        }</td></tr>
<tr><th id="456">456</th><td></td></tr>
<tr><th id="457">457</th><td>        <b>if</b> (<a class="local col8 ref" href="#38advise_large_objects" title='advise_large_objects' data-ref="38advise_large_objects">advise_large_objects</a>) {</td></tr>
<tr><th id="458">458</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Deleting, expiring or evicting (because of maxmemory policy) large objects is a blocking operation. If you have very large objects that are often deleted, expired, or evicted, try to fragment those objects into multiple smaller objects.\n"</q>);</td></tr>
<tr><th id="459">459</th><td>        }</td></tr>
<tr><th id="460">460</th><td></td></tr>
<tr><th id="461">461</th><td>        <b>if</b> (<a class="local col9 ref" href="#39advise_mass_eviction" title='advise_mass_eviction' data-ref="39advise_mass_eviction">advise_mass_eviction</a>) {</td></tr>
<tr><th id="462">462</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- Sudden changes to the 'maxmemory' setting via 'CONFIG SET', or allocation of large objects via sets or sorted sets intersections, STORE option of SORT, Redis Cluster large keys migrations (RESTORE command), may create sudden memory pressure forcing the server to block trying to evict keys. \n"</q>);</td></tr>
<tr><th id="463">463</th><td>        }</td></tr>
<tr><th id="464">464</th><td></td></tr>
<tr><th id="465">465</th><td>        <b>if</b> (<a class="local col1 ref" href="#41advise_disable_thp" title='advise_disable_thp' data-ref="41advise_disable_thp">advise_disable_thp</a>) {</td></tr>
<tr><th id="466">466</th><td>            <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a> = <a class="ref fn" href="sds.h.html#sdscat" title='sdscat' data-ref="sdscat">sdscat</a>(<a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>,<q>"- I detected a non zero amount of anonymous huge pages used by your process. This creates very serious latency events in different conditions, especially when Redis is persisting on disk. To disable THP support use the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled', make sure to also add it into /etc/rc.local so that the command will be executed again after a reboot. Note that even if you have already disabled THP, you still need to restart the Redis process to get rid of the huge pages already created.\n"</q>);</td></tr>
<tr><th id="467">467</th><td>        }</td></tr>
<tr><th id="468">468</th><td>    }</td></tr>
<tr><th id="469">469</th><td></td></tr>
<tr><th id="470">470</th><td>    <b>return</b> <a class="local col5 ref" href="#25report" title='report' data-ref="25report">report</a>;</td></tr>
<tr><th id="471">471</th><td>}</td></tr>
<tr><th id="472">472</th><td></td></tr>
<tr><th id="473">473</th><td><i>/* ---------------------- Latency command implementation -------------------- */</i></td></tr>
<tr><th id="474">474</th><td></td></tr>
<tr><th id="475">475</th><td><i>/* latencyCommand() helper to produce a time-delay reply for all the samples</i></td></tr>
<tr><th id="476">476</th><td><i> * in memory for the specified time series. */</i></td></tr>
<tr><th id="477">477</th><td><em>void</em> <dfn class="decl def fn" id="latencyCommandReplyWithSamples" title='latencyCommandReplyWithSamples' data-ref="latencyCommandReplyWithSamples">latencyCommandReplyWithSamples</dfn>(<a class="typedef" href="redis.h.html#redisClient" title='redisClient' data-type='struct redisClient' data-ref="redisClient">redisClient</a> *<dfn class="local col0 decl" id="50c" title='c' data-type='redisClient *' data-ref="50c">c</dfn>, <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col1 decl" id="51ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="51ts">ts</dfn>) {</td></tr>
<tr><th id="478">478</th><td>    <em>void</em> *<dfn class="local col2 decl" id="52replylen" title='replylen' data-type='void *' data-ref="52replylen">replylen</dfn> = <a class="ref fn" href="redis.h.html#addDeferredMultiBulkLength" title='addDeferredMultiBulkLength' data-ref="addDeferredMultiBulkLength">addDeferredMultiBulkLength</a>(<a class="local col0 ref" href="#50c" title='c' data-ref="50c">c</a>);</td></tr>
<tr><th id="479">479</th><td>    <em>int</em> <dfn class="local col3 decl" id="53samples" title='samples' data-type='int' data-ref="53samples">samples</dfn> = <var>0</var>, <dfn class="local col4 decl" id="54j" title='j' data-type='int' data-ref="54j">j</dfn>;</td></tr>
<tr><th id="480">480</th><td></td></tr>
<tr><th id="481">481</th><td>    <b>for</b> (<a class="local col4 ref" href="#54j" title='j' data-ref="54j">j</a> = <var>0</var>; <a class="local col4 ref" href="#54j" title='j' data-ref="54j">j</a> &lt; <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>; <a class="local col4 ref" href="#54j" title='j' data-ref="54j">j</a>++) {</td></tr>
<tr><th id="482">482</th><td>        <em>int</em> <dfn class="local col5 decl" id="55i" title='i' data-type='int' data-ref="55i">i</dfn> = (<a class="local col1 ref" href="#51ts" title='ts' data-ref="51ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> + <a class="local col4 ref" href="#54j" title='j' data-ref="54j">j</a>) % <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>;</td></tr>
<tr><th id="483">483</th><td></td></tr>
<tr><th id="484">484</th><td>        <b>if</b> (<a class="local col1 ref" href="#51ts" title='ts' data-ref="51ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col5 ref" href="#55i" title='i' data-ref="55i">i</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> == <var>0</var>) <b>continue</b>;</td></tr>
<tr><th id="485">485</th><td>        <a class="ref fn" href="redis.h.html#addReplyMultiBulkLen" title='addReplyMultiBulkLen' data-ref="addReplyMultiBulkLen">addReplyMultiBulkLen</a>(<a class="local col0 ref" href="#50c" title='c' data-ref="50c">c</a>,<var>2</var>);</td></tr>
<tr><th id="486">486</th><td>        <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col0 ref" href="#50c" title='c' data-ref="50c">c</a>,<a class="local col1 ref" href="#51ts" title='ts' data-ref="51ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col5 ref" href="#55i" title='i' data-ref="55i">i</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a>);</td></tr>
<tr><th id="487">487</th><td>        <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col0 ref" href="#50c" title='c' data-ref="50c">c</a>,<a class="local col1 ref" href="#51ts" title='ts' data-ref="51ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col5 ref" href="#55i" title='i' data-ref="55i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>);</td></tr>
<tr><th id="488">488</th><td>        <a class="local col3 ref" href="#53samples" title='samples' data-ref="53samples">samples</a>++;</td></tr>
<tr><th id="489">489</th><td>    }</td></tr>
<tr><th id="490">490</th><td>    <a class="ref fn" href="redis.h.html#setDeferredMultiBulkLength" title='setDeferredMultiBulkLength' data-ref="setDeferredMultiBulkLength">setDeferredMultiBulkLength</a>(<a class="local col0 ref" href="#50c" title='c' data-ref="50c">c</a>,<a class="local col2 ref" href="#52replylen" title='replylen' data-ref="52replylen">replylen</a>,<a class="local col3 ref" href="#53samples" title='samples' data-ref="53samples">samples</a>);</td></tr>
<tr><th id="491">491</th><td>}</td></tr>
<tr><th id="492">492</th><td></td></tr>
<tr><th id="493">493</th><td><i>/* latencyCommand() helper to produce the reply for the LATEST subcommand,</i></td></tr>
<tr><th id="494">494</th><td><i> * listing the last latency sample for every event type registered so far. */</i></td></tr>
<tr><th id="495">495</th><td><em>void</em> <dfn class="decl def fn" id="latencyCommandReplyWithLatestEvents" title='latencyCommandReplyWithLatestEvents' data-ref="latencyCommandReplyWithLatestEvents">latencyCommandReplyWithLatestEvents</dfn>(<a class="typedef" href="redis.h.html#redisClient" title='redisClient' data-type='struct redisClient' data-ref="redisClient">redisClient</a> *<dfn class="local col6 decl" id="56c" title='c' data-type='redisClient *' data-ref="56c">c</dfn>) {</td></tr>
<tr><th id="496">496</th><td>    <a class="typedef" href="dict.h.html#dictIterator" title='dictIterator' data-type='struct dictIterator' data-ref="dictIterator">dictIterator</a> *<dfn class="local col7 decl" id="57di" title='di' data-type='dictIterator *' data-ref="57di">di</dfn>;</td></tr>
<tr><th id="497">497</th><td>    <a class="typedef" href="dict.h.html#dictEntry" title='dictEntry' data-type='struct dictEntry' data-ref="dictEntry">dictEntry</a> *<dfn class="local col8 decl" id="58de" title='de' data-type='dictEntry *' data-ref="58de">de</dfn>;</td></tr>
<tr><th id="498">498</th><td></td></tr>
<tr><th id="499">499</th><td>    <a class="ref fn" href="redis.h.html#addReplyMultiBulkLen" title='addReplyMultiBulkLen' data-ref="addReplyMultiBulkLen">addReplyMultiBulkLen</a>(<a class="local col6 ref" href="#56c" title='c' data-ref="56c">c</a>,<a class="macro" href="dict.h.html#146" title="((server.latency_events)-&gt;ht[0].used+(server.latency_events)-&gt;ht[1].used)" data-ref="_M/dictSize">dictSize</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>));</td></tr>
<tr><th id="500">500</th><td>    <a class="local col7 ref" href="#57di" title='di' data-ref="57di">di</a> = <a class="ref fn" href="dict.h.html#dictGetIterator" title='dictGetIterator' data-ref="dictGetIterator">dictGetIterator</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>);</td></tr>
<tr><th id="501">501</th><td>    <b>while</b>((<a class="local col8 ref" href="#58de" title='de' data-ref="58de">de</a> = <a class="ref fn" href="dict.h.html#dictNext" title='dictNext' data-ref="dictNext">dictNext</a>(<a class="local col7 ref" href="#57di" title='di' data-ref="57di">di</a>)) != <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) {</td></tr>
<tr><th id="502">502</th><td>        <em>char</em> *<dfn class="local col9 decl" id="59event" title='event' data-type='char *' data-ref="59event">event</dfn> = <a class="macro" href="dict.h.html#140" title="((de)-&gt;key)" data-ref="_M/dictGetKey">dictGetKey</a>(<a class="local col8 ref" href="#58de" title='de' data-ref="58de">de</a>);</td></tr>
<tr><th id="503">503</th><td>        <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col0 decl" id="60ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="60ts">ts</dfn> = <a class="macro" href="dict.h.html#141" title="((de)-&gt;v.val)" data-ref="_M/dictGetVal">dictGetVal</a>(<a class="local col8 ref" href="#58de" title='de' data-ref="58de">de</a>);</td></tr>
<tr><th id="504">504</th><td>        <em>int</em> <dfn class="local col1 decl" id="61last" title='last' data-type='int' data-ref="61last">last</dfn> = (<a class="local col0 ref" href="#60ts" title='ts' data-ref="60ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> + <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a> - <var>1</var>) % <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>;</td></tr>
<tr><th id="505">505</th><td></td></tr>
<tr><th id="506">506</th><td>        <a class="ref fn" href="redis.h.html#addReplyMultiBulkLen" title='addReplyMultiBulkLen' data-ref="addReplyMultiBulkLen">addReplyMultiBulkLen</a>(<a class="local col6 ref" href="#56c" title='c' data-ref="56c">c</a>,<var>4</var>);</td></tr>
<tr><th id="507">507</th><td>        <a class="ref fn" href="redis.h.html#addReplyBulkCString" title='addReplyBulkCString' data-ref="addReplyBulkCString">addReplyBulkCString</a>(<a class="local col6 ref" href="#56c" title='c' data-ref="56c">c</a>,<a class="local col9 ref" href="#59event" title='event' data-ref="59event">event</a>);</td></tr>
<tr><th id="508">508</th><td>        <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col6 ref" href="#56c" title='c' data-ref="56c">c</a>,<a class="local col0 ref" href="#60ts" title='ts' data-ref="60ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col1 ref" href="#61last" title='last' data-ref="61last">last</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a>);</td></tr>
<tr><th id="509">509</th><td>        <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col6 ref" href="#56c" title='c' data-ref="56c">c</a>,<a class="local col0 ref" href="#60ts" title='ts' data-ref="60ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col1 ref" href="#61last" title='last' data-ref="61last">last</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>);</td></tr>
<tr><th id="510">510</th><td>        <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col6 ref" href="#56c" title='c' data-ref="56c">c</a>,<a class="local col0 ref" href="#60ts" title='ts' data-ref="60ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a>);</td></tr>
<tr><th id="511">511</th><td>    }</td></tr>
<tr><th id="512">512</th><td>    <a class="ref fn" href="dict.h.html#dictReleaseIterator" title='dictReleaseIterator' data-ref="dictReleaseIterator">dictReleaseIterator</a>(<a class="local col7 ref" href="#57di" title='di' data-ref="57di">di</a>);</td></tr>
<tr><th id="513">513</th><td>}</td></tr>
<tr><th id="514">514</th><td></td></tr>
<tr><th id="515">515</th><td><u>#define <dfn class="macro" id="_M/LATENCY_GRAPH_COLS" data-ref="_M/LATENCY_GRAPH_COLS">LATENCY_GRAPH_COLS</dfn> 80</u></td></tr>
<tr><th id="516">516</th><td><a class="typedef" href="sds.h.html#sds" title='sds' data-type='char *' data-ref="sds">sds</a> <dfn class="decl def fn" id="latencyCommandGenSparkeline" title='latencyCommandGenSparkeline' data-ref="latencyCommandGenSparkeline">latencyCommandGenSparkeline</dfn>(<em>char</em> *<dfn class="local col2 decl" id="62event" title='event' data-type='char *' data-ref="62event">event</dfn>, <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col3 decl" id="63ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="63ts">ts</dfn>) {</td></tr>
<tr><th id="517">517</th><td>    <em>int</em> <dfn class="local col4 decl" id="64j" title='j' data-type='int' data-ref="64j">j</dfn>;</td></tr>
<tr><th id="518">518</th><td>    <b>struct</b> <a class="type" href="sparkline.h.html#sequence" title='sequence' data-ref="sequence">sequence</a> *<dfn class="local col5 decl" id="65seq" title='seq' data-type='struct sequence *' data-ref="65seq">seq</dfn> = <a class="ref fn" href="sparkline.h.html#createSparklineSequence" title='createSparklineSequence' data-ref="createSparklineSequence">createSparklineSequence</a>();</td></tr>
<tr><th id="519">519</th><td>    <a class="typedef" href="sds.h.html#sds" title='sds' data-type='char *' data-ref="sds">sds</a> <dfn class="local col6 decl" id="66graph" title='graph' data-type='sds' data-ref="66graph">graph</dfn> = <a class="ref fn" href="sds.h.html#sdsempty" title='sdsempty' data-ref="sdsempty">sdsempty</a>();</td></tr>
<tr><th id="520">520</th><td>    <a class="typedef" href="../../include/stdint.h.html#uint32_t" title='uint32_t' data-type='unsigned int' data-ref="uint32_t">uint32_t</a> <dfn class="local col7 decl" id="67min" title='min' data-type='uint32_t' data-ref="67min">min</dfn> = <var>0</var>, <dfn class="local col8 decl" id="68max" title='max' data-type='uint32_t' data-ref="68max">max</dfn> = <var>0</var>;</td></tr>
<tr><th id="521">521</th><td></td></tr>
<tr><th id="522">522</th><td>    <b>for</b> (<a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a> = <var>0</var>; <a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a> &lt; <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>; <a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a>++) {</td></tr>
<tr><th id="523">523</th><td>        <em>int</em> <dfn class="local col9 decl" id="69i" title='i' data-type='int' data-ref="69i">i</dfn> = (<a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::idx" title='latencyTimeSeries::idx' data-ref="latencyTimeSeries::idx">idx</a> + <a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a>) % <a class="macro" href="latency.h.html#37" title="160" data-ref="_M/LATENCY_TS_LEN">LATENCY_TS_LEN</a>;</td></tr>
<tr><th id="524">524</th><td>        <em>int</em> <dfn class="local col0 decl" id="70elapsed" title='elapsed' data-type='int' data-ref="70elapsed">elapsed</dfn>;</td></tr>
<tr><th id="525">525</th><td>        <em>char</em> <dfn class="local col1 decl" id="71buf" title='buf' data-type='char [64]' data-ref="71buf">buf</dfn>[<var>64</var>];</td></tr>
<tr><th id="526">526</th><td></td></tr>
<tr><th id="527">527</th><td>        <b>if</b> (<a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a> == <var>0</var>) <b>continue</b>;</td></tr>
<tr><th id="528">528</th><td>        <i>/* Update min and max. */</i></td></tr>
<tr><th id="529">529</th><td>        <b>if</b> (<a class="local col5 ref" href="#65seq" title='seq' data-ref="65seq">seq</a>-&gt;<a class="ref field" href="sparkline.h.html#sequence::length" title='sequence::length' data-ref="sequence::length">length</a> == <var>0</var>) {</td></tr>
<tr><th id="530">530</th><td>            <a class="local col7 ref" href="#67min" title='min' data-ref="67min">min</a> = <a class="local col8 ref" href="#68max" title='max' data-ref="68max">max</a> = <a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="531">531</th><td>        } <b>else</b> {</td></tr>
<tr><th id="532">532</th><td>            <b>if</b> (<a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a> &gt; <a class="local col8 ref" href="#68max" title='max' data-ref="68max">max</a>) <a class="local col8 ref" href="#68max" title='max' data-ref="68max">max</a> = <a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="533">533</th><td>            <b>if</b> (<a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a> &lt; <a class="local col7 ref" href="#67min" title='min' data-ref="67min">min</a>) <a class="local col7 ref" href="#67min" title='min' data-ref="67min">min</a> = <a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>;</td></tr>
<tr><th id="534">534</th><td>        }</td></tr>
<tr><th id="535">535</th><td>        <i>/* Use as label the number of seconds / minutes / hours / days</i></td></tr>
<tr><th id="536">536</th><td><i>         * ago the event happened. */</i></td></tr>
<tr><th id="537">537</th><td>        <a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a> = <a class="ref fn" href="../../include/time.h.html#time" title='time' data-ref="time">time</a>(<span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) - <a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::time" title='latencySample::time' data-ref="latencySample::time">time</a>;</td></tr>
<tr><th id="538">538</th><td>        <b>if</b> (<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a> &lt; <var>60</var>)</td></tr>
<tr><th id="539">539</th><td>            <a class="ref fn" href="../../include/stdio.h.html#snprintf" title='snprintf' data-ref="snprintf">snprintf</a>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>,<b>sizeof</b>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>),<q>"%ds"</q>,<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a>);</td></tr>
<tr><th id="540">540</th><td>        <b>else</b> <b>if</b> (<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a> &lt; <var>3600</var>)</td></tr>
<tr><th id="541">541</th><td>            <a class="ref fn" href="../../include/stdio.h.html#snprintf" title='snprintf' data-ref="snprintf">snprintf</a>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>,<b>sizeof</b>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>),<q>"%dm"</q>,<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a>/<var>60</var>);</td></tr>
<tr><th id="542">542</th><td>        <b>else</b> <b>if</b> (<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a> &lt; <var>3600</var>*<var>24</var>)</td></tr>
<tr><th id="543">543</th><td>            <a class="ref fn" href="../../include/stdio.h.html#snprintf" title='snprintf' data-ref="snprintf">snprintf</a>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>,<b>sizeof</b>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>),<q>"%dh"</q>,<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a>/<var>3600</var>);</td></tr>
<tr><th id="544">544</th><td>        <b>else</b></td></tr>
<tr><th id="545">545</th><td>            <a class="ref fn" href="../../include/stdio.h.html#snprintf" title='snprintf' data-ref="snprintf">snprintf</a>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>,<b>sizeof</b>(<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>),<q>"%dd"</q>,<a class="local col0 ref" href="#70elapsed" title='elapsed' data-ref="70elapsed">elapsed</a>/(<var>3600</var>*<var>24</var>));</td></tr>
<tr><th id="546">546</th><td>        <a class="ref fn" href="sparkline.h.html#sparklineSequenceAddSample" title='sparklineSequenceAddSample' data-ref="sparklineSequenceAddSample">sparklineSequenceAddSample</a>(<a class="local col5 ref" href="#65seq" title='seq' data-ref="65seq">seq</a>,<a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::samples" title='latencyTimeSeries::samples' data-ref="latencyTimeSeries::samples">samples</a>[<a class="local col9 ref" href="#69i" title='i' data-ref="69i">i</a>].<a class="ref field" href="latency.h.html#latencySample::latency" title='latencySample::latency' data-ref="latencySample::latency">latency</a>,<a class="local col1 ref" href="#71buf" title='buf' data-ref="71buf">buf</a>);</td></tr>
<tr><th id="547">547</th><td>    }</td></tr>
<tr><th id="548">548</th><td></td></tr>
<tr><th id="549">549</th><td>    <a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a> = <a class="ref fn" href="sds.h.html#sdscatprintf" title='sdscatprintf' data-ref="sdscatprintf">sdscatprintf</a>(<a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a>,</td></tr>
<tr><th id="550">550</th><td>        <q>"%s - high %lu ms, low %lu ms (all time high %lu ms)\n"</q>, <a class="local col2 ref" href="#62event" title='event' data-ref="62event">event</a>,</td></tr>
<tr><th id="551">551</th><td>        (<em>unsigned</em> <em>long</em>) <a class="local col8 ref" href="#68max" title='max' data-ref="68max">max</a>, (<em>unsigned</em> <em>long</em>) <a class="local col7 ref" href="#67min" title='min' data-ref="67min">min</a>, (<em>unsigned</em> <em>long</em>) <a class="local col3 ref" href="#63ts" title='ts' data-ref="63ts">ts</a>-&gt;<a class="ref field" href="latency.h.html#latencyTimeSeries::max" title='latencyTimeSeries::max' data-ref="latencyTimeSeries::max">max</a>);</td></tr>
<tr><th id="552">552</th><td>    <b>for</b> (<a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a> = <var>0</var>; <a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a> &lt; <a class="macro" href="#515" title="80" data-ref="_M/LATENCY_GRAPH_COLS">LATENCY_GRAPH_COLS</a>; <a class="local col4 ref" href="#64j" title='j' data-ref="64j">j</a>++)</td></tr>
<tr><th id="553">553</th><td>        <a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a> = <a class="ref fn" href="sds.h.html#sdscatlen" title='sdscatlen' data-ref="sdscatlen">sdscatlen</a>(<a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a>,<q>"-"</q>,<var>1</var>);</td></tr>
<tr><th id="554">554</th><td>    <a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a> = <a class="ref fn" href="sds.h.html#sdscatlen" title='sdscatlen' data-ref="sdscatlen">sdscatlen</a>(<a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a>,<q>"\n"</q>,<var>1</var>);</td></tr>
<tr><th id="555">555</th><td>    <a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a> = <a class="ref fn" href="sparkline.h.html#sparklineRender" title='sparklineRender' data-ref="sparklineRender">sparklineRender</a>(<a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a>,<a class="local col5 ref" href="#65seq" title='seq' data-ref="65seq">seq</a>,<a class="macro" href="#515" title="80" data-ref="_M/LATENCY_GRAPH_COLS">LATENCY_GRAPH_COLS</a>,<var>4</var>,<a class="macro" href="sparkline.h.html#47" title="1" data-ref="_M/SPARKLINE_FILL">SPARKLINE_FILL</a>);</td></tr>
<tr><th id="556">556</th><td>    <a class="ref fn" href="sparkline.h.html#freeSparklineSequence" title='freeSparklineSequence' data-ref="freeSparklineSequence">freeSparklineSequence</a>(<a class="local col5 ref" href="#65seq" title='seq' data-ref="65seq">seq</a>);</td></tr>
<tr><th id="557">557</th><td>    <b>return</b> <a class="local col6 ref" href="#66graph" title='graph' data-ref="66graph">graph</a>;</td></tr>
<tr><th id="558">558</th><td>}</td></tr>
<tr><th id="559">559</th><td></td></tr>
<tr><th id="560">560</th><td><i>/* LATENCY command implementations.</i></td></tr>
<tr><th id="561">561</th><td><i> *</i></td></tr>
<tr><th id="562">562</th><td><i> * LATENCY SAMPLES: return time-latency samples for the specified event.</i></td></tr>
<tr><th id="563">563</th><td><i> * LATENCY LATEST: return the latest latency for all the events classes.</i></td></tr>
<tr><th id="564">564</th><td><i> * LATENCY DOCTOR: returns an human readable analysis of instance latency.</i></td></tr>
<tr><th id="565">565</th><td><i> * LATENCY GRAPH: provide an ASCII graph of the latency of the specified event.</i></td></tr>
<tr><th id="566">566</th><td><i> */</i></td></tr>
<tr><th id="567">567</th><td><em>void</em> <dfn class="decl def fn" id="latencyCommand" title='latencyCommand' data-ref="latencyCommand">latencyCommand</dfn>(<a class="typedef" href="redis.h.html#redisClient" title='redisClient' data-type='struct redisClient' data-ref="redisClient">redisClient</a> *<dfn class="local col2 decl" id="72c" title='c' data-type='redisClient *' data-ref="72c">c</dfn>) {</td></tr>
<tr><th id="568">568</th><td>    <b>struct</b> <a class="type" href="latency.h.html#latencyTimeSeries" title='latencyTimeSeries' data-ref="latencyTimeSeries">latencyTimeSeries</a> *<dfn class="local col3 decl" id="73ts" title='ts' data-type='struct latencyTimeSeries *' data-ref="73ts">ts</dfn>;</td></tr>
<tr><th id="569">569</th><td></td></tr>
<tr><th id="570">570</th><td>    <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>1</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>,<q>"history"</q>) &amp;&amp; <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a> == <var>3</var>) {</td></tr>
<tr><th id="571">571</th><td>        <i>/* LATENCY HISTORY &lt;event&gt; */</i></td></tr>
<tr><th id="572">572</th><td>        <a class="local col3 ref" href="#73ts" title='ts' data-ref="73ts">ts</a> = <a class="ref fn" href="dict.h.html#dictFetchValue" title='dictFetchValue' data-ref="dictFetchValue">dictFetchValue</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>,<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>2</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>);</td></tr>
<tr><th id="573">573</th><td>        <b>if</b> (<a class="local col3 ref" href="#73ts" title='ts' data-ref="73ts">ts</a> == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) {</td></tr>
<tr><th id="574">574</th><td>            <a class="ref fn" href="redis.h.html#addReplyMultiBulkLen" title='addReplyMultiBulkLen' data-ref="addReplyMultiBulkLen">addReplyMultiBulkLen</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<var>0</var>);</td></tr>
<tr><th id="575">575</th><td>        } <b>else</b> {</td></tr>
<tr><th id="576">576</th><td>            <a class="ref fn" href="#latencyCommandReplyWithSamples" title='latencyCommandReplyWithSamples' data-ref="latencyCommandReplyWithSamples">latencyCommandReplyWithSamples</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<a class="local col3 ref" href="#73ts" title='ts' data-ref="73ts">ts</a>);</td></tr>
<tr><th id="577">577</th><td>        }</td></tr>
<tr><th id="578">578</th><td>    } <b>else</b> <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>1</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>,<q>"graph"</q>) &amp;&amp; <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a> == <var>3</var>) {</td></tr>
<tr><th id="579">579</th><td>        <i>/* LATENCY GRAPH &lt;event&gt; */</i></td></tr>
<tr><th id="580">580</th><td>        <a class="typedef" href="sds.h.html#sds" title='sds' data-type='char *' data-ref="sds">sds</a> <dfn class="local col4 decl" id="74graph" title='graph' data-type='sds' data-ref="74graph">graph</dfn>;</td></tr>
<tr><th id="581">581</th><td>        <a class="typedef" href="dict.h.html#dictEntry" title='dictEntry' data-type='struct dictEntry' data-ref="dictEntry">dictEntry</a> *<dfn class="local col5 decl" id="75de" title='de' data-type='dictEntry *' data-ref="75de">de</dfn>;</td></tr>
<tr><th id="582">582</th><td>        <em>char</em> *<dfn class="local col6 decl" id="76event" title='event' data-type='char *' data-ref="76event">event</dfn>;</td></tr>
<tr><th id="583">583</th><td></td></tr>
<tr><th id="584">584</th><td>        <a class="local col5 ref" href="#75de" title='de' data-ref="75de">de</a> = <a class="ref fn" href="dict.h.html#dictFind" title='dictFind' data-ref="dictFind">dictFind</a>(<a class="ref" href="redis.h.html#server" title='server' data-ref="server">server</a>.<a class="ref field" href="redis.h.html#redisServer::latency_events" title='redisServer::latency_events' data-ref="redisServer::latency_events">latency_events</a>,<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>2</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>);</td></tr>
<tr><th id="585">585</th><td>        <b>if</b> (<a class="local col5 ref" href="#75de" title='de' data-ref="75de">de</a> == <span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>) <b>goto</b> <a class="lbl" href="#77nodataerr" data-ref="77nodataerr">nodataerr</a>;</td></tr>
<tr><th id="586">586</th><td>        <a class="local col3 ref" href="#73ts" title='ts' data-ref="73ts">ts</a> = <a class="macro" href="dict.h.html#141" title="((de)-&gt;v.val)" data-ref="_M/dictGetVal">dictGetVal</a>(<a class="local col5 ref" href="#75de" title='de' data-ref="75de">de</a>);</td></tr>
<tr><th id="587">587</th><td>        <a class="local col6 ref" href="#76event" title='event' data-ref="76event">event</a> = <a class="macro" href="dict.h.html#140" title="((de)-&gt;key)" data-ref="_M/dictGetKey">dictGetKey</a>(<a class="local col5 ref" href="#75de" title='de' data-ref="75de">de</a>);</td></tr>
<tr><th id="588">588</th><td></td></tr>
<tr><th id="589">589</th><td>        <a class="local col4 ref" href="#74graph" title='graph' data-ref="74graph">graph</a> = <a class="ref fn" href="#latencyCommandGenSparkeline" title='latencyCommandGenSparkeline' data-ref="latencyCommandGenSparkeline">latencyCommandGenSparkeline</a>(<a class="local col6 ref" href="#76event" title='event' data-ref="76event">event</a>,<a class="local col3 ref" href="#73ts" title='ts' data-ref="73ts">ts</a>);</td></tr>
<tr><th id="590">590</th><td>        <a class="ref fn" href="redis.h.html#addReplyBulkCString" title='addReplyBulkCString' data-ref="addReplyBulkCString">addReplyBulkCString</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<a class="local col4 ref" href="#74graph" title='graph' data-ref="74graph">graph</a>);</td></tr>
<tr><th id="591">591</th><td>        <a class="ref fn" href="sds.h.html#sdsfree" title='sdsfree' data-ref="sdsfree">sdsfree</a>(<a class="local col4 ref" href="#74graph" title='graph' data-ref="74graph">graph</a>);</td></tr>
<tr><th id="592">592</th><td>    } <b>else</b> <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>1</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>,<q>"latest"</q>) &amp;&amp; <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a> == <var>2</var>) {</td></tr>
<tr><th id="593">593</th><td>        <i>/* LATENCY LATEST */</i></td></tr>
<tr><th id="594">594</th><td>        <a class="ref fn" href="#latencyCommandReplyWithLatestEvents" title='latencyCommandReplyWithLatestEvents' data-ref="latencyCommandReplyWithLatestEvents">latencyCommandReplyWithLatestEvents</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>);</td></tr>
<tr><th id="595">595</th><td>    } <b>else</b> <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>1</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>,<q>"doctor"</q>) &amp;&amp; <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a> == <var>2</var>) {</td></tr>
<tr><th id="596">596</th><td>        <i>/* LATENCY DOCTOR */</i></td></tr>
<tr><th id="597">597</th><td>        <a class="typedef" href="sds.h.html#sds" title='sds' data-type='char *' data-ref="sds">sds</a> <dfn class="local col8 decl" id="78report" title='report' data-type='sds' data-ref="78report">report</dfn> = <a class="ref fn" href="#createLatencyReport" title='createLatencyReport' data-ref="createLatencyReport">createLatencyReport</a>();</td></tr>
<tr><th id="598">598</th><td></td></tr>
<tr><th id="599">599</th><td>        <a class="ref fn" href="redis.h.html#addReplyBulkCBuffer" title='addReplyBulkCBuffer' data-ref="addReplyBulkCBuffer">addReplyBulkCBuffer</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<a class="local col8 ref" href="#78report" title='report' data-ref="78report">report</a>,<a class="ref fn" href="sds.h.html#sdslen" title='sdslen' data-ref="sdslen">sdslen</a>(<a class="local col8 ref" href="#78report" title='report' data-ref="78report">report</a>));</td></tr>
<tr><th id="600">600</th><td>        <a class="ref fn" href="sds.h.html#sdsfree" title='sdsfree' data-ref="sdsfree">sdsfree</a>(<a class="local col8 ref" href="#78report" title='report' data-ref="78report">report</a>);</td></tr>
<tr><th id="601">601</th><td>    } <b>else</b> <b>if</b> (!<a class="ref fn" href="../../include/string.h.html#strcasecmp" title='strcasecmp' data-ref="strcasecmp">strcasecmp</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>1</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>,<q>"reset"</q>) &amp;&amp; <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a> &gt;= <var>2</var>) {</td></tr>
<tr><th id="602">602</th><td>        <i>/* LATENCY RESET */</i></td></tr>
<tr><th id="603">603</th><td>        <b>if</b> (<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a> == <var>2</var>) {</td></tr>
<tr><th id="604">604</th><td>            <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<a class="ref fn" href="#latencyResetEvent" title='latencyResetEvent' data-ref="latencyResetEvent">latencyResetEvent</a>(<span class="macro" title="((void*)0)" data-ref="_M/NULL">NULL</span>));</td></tr>
<tr><th id="605">605</th><td>        } <b>else</b> {</td></tr>
<tr><th id="606">606</th><td>            <em>int</em> <dfn class="local col9 decl" id="79j" title='j' data-type='int' data-ref="79j">j</dfn>, <dfn class="local col0 decl" id="80resets" title='resets' data-type='int' data-ref="80resets">resets</dfn> = <var>0</var>;</td></tr>
<tr><th id="607">607</th><td></td></tr>
<tr><th id="608">608</th><td>            <b>for</b> (<a class="local col9 ref" href="#79j" title='j' data-ref="79j">j</a> = <var>2</var>; <a class="local col9 ref" href="#79j" title='j' data-ref="79j">j</a> &lt; <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argc" title='redisClient::argc' data-ref="redisClient::argc">argc</a>; <a class="local col9 ref" href="#79j" title='j' data-ref="79j">j</a>++)</td></tr>
<tr><th id="609">609</th><td>                <a class="local col0 ref" href="#80resets" title='resets' data-ref="80resets">resets</a> += <a class="ref fn" href="#latencyResetEvent" title='latencyResetEvent' data-ref="latencyResetEvent">latencyResetEvent</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<a class="local col9 ref" href="#79j" title='j' data-ref="79j">j</a>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>);</td></tr>
<tr><th id="610">610</th><td>            <a class="ref fn" href="redis.h.html#addReplyLongLong" title='addReplyLongLong' data-ref="addReplyLongLong">addReplyLongLong</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<a class="local col0 ref" href="#80resets" title='resets' data-ref="80resets">resets</a>);</td></tr>
<tr><th id="611">611</th><td>        }</td></tr>
<tr><th id="612">612</th><td>    } <b>else</b> {</td></tr>
<tr><th id="613">613</th><td>        <a class="ref fn" href="redis.h.html#addReply" title='addReply' data-ref="addReply">addReply</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,<a class="ref" href="redis.h.html#shared" title='shared' data-ref="shared">shared</a>.<a class="ref field" href="redis.h.html#sharedObjectsStruct::syntaxerr" title='sharedObjectsStruct::syntaxerr' data-ref="sharedObjectsStruct::syntaxerr">syntaxerr</a>);</td></tr>
<tr><th id="614">614</th><td>    }</td></tr>
<tr><th id="615">615</th><td>    <b>return</b>;</td></tr>
<tr><th id="616">616</th><td></td></tr>
<tr><th id="617">617</th><td><dfn class="lbl" id="77nodataerr" data-ref="77nodataerr">nodataerr</dfn>:</td></tr>
<tr><th id="618">618</th><td>    <i>/* Common error when the user asks for an event we have no latency</i></td></tr>
<tr><th id="619">619</th><td><i>     * information about. */</i></td></tr>
<tr><th id="620">620</th><td>    <a class="ref fn" href="redis.h.html#addReplyErrorFormat" title='addReplyErrorFormat' data-ref="addReplyErrorFormat">addReplyErrorFormat</a>(<a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>,</td></tr>
<tr><th id="621">621</th><td>        <q>"No samples available for event '%s'"</q>, (<em>char</em>*) <a class="local col2 ref" href="#72c" title='c' data-ref="72c">c</a>-&gt;<a class="ref field" href="redis.h.html#redisClient::argv" title='redisClient::argv' data-ref="redisClient::argv">argv</a>[<var>2</var>]-&gt;<a class="ref field" href="redis.h.html#redisObject::ptr" title='redisObject::ptr' data-ref="redisObject::ptr">ptr</a>);</td></tr>
<tr><th id="622">622</th><td>}</td></tr>
<tr><th id="623">623</th><td></td></tr>
<tr><th id="624">624</th><td></td></tr>
</table><hr/><p id='footer'>
Generated on <em>2018-Apr-06</em> from project redis revision <em>77d3b16</em><br />Powered by <a href='https://woboq.com'><img alt='Woboq' src='https://code.woboq.org/woboq-16.png' width='41' height='16' /></a> <a href='https://code.woboq.org'>Code Browser</a> 2.1
<br/>Generator usage only permitted with license.</p>
</div></body></html>
